<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appearance Anxiety Filter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #a7e2e3, #e2a7e3);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 1.5rem;
            /* 調整: 縮小主容器寬度 */
            max-width: 450px; 
            width: 95%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: max-width 0.3s;
        }
        @media (min-width: 768px) {
            .container {
                /* 調整: 縮小桌面版寬度 */
                max-width: 650px; 
            }
        }
        .container.gallery-view {
            /* 調整: 縮小圖庫檢視寬度 */
            max-width: 750px;
        }
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 50%;
            height: 4px;
            background-color: #6d28d9;
            border-radius: 2px;
        }
        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        .checkbox-label {
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        input[type="checkbox"]:checked + .checkbox-label {
            background-color: #6d28d9;
            border-color: #6d28d9;
            color: #fff;
            box-shadow: 0 4px 10px rgba(109, 40, 217, 0.2);
        }
        
        .file-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            border: 2px dashed #a855f7;
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #6d28d9;
            font-weight: 600;
            margin-top: 1rem;
        }
        .file-box:hover {
            background-color: #f3e8ff;
        }
        .file-box.gallery-upload-style {
            background-color: #f3e8ff;
            border-color: #6d28d9;
        }
        .file-box.gallery-upload-style:hover {
            background-color: #f2e1ff;
        }
        .file-box svg {
            width: 2rem;
            height: 2rem;
            margin-bottom: 0.5rem;
        }
        .slogan {
            font-style: italic;
            font-weight: 700;
            color: #6d28d9;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            font-size: 1.125rem;
        }
        .size-input-container {
            margin-top: 1rem;
            display: grid;
            gap: 1rem;
        }
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
        }
        .feedback.positive {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        .feedback.negative {
            background-color: #ffcdd2;
            color: #d32f2f;
        }
        .gallery {
            /* 調整: 讓網格間距更大一點 */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 0.6rem;
            margin-top: 1rem;
        }
        
        /* Experiment Item Styling */
        .selection-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .selection-item {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 3px solid transparent;
            transition: all 0.2s;
            filter: grayscale(0.5); 
            border-radius: 0.5rem;
        }
        .selection-wrapper.selected .selection-item {
            border-color: #ef4444; /* Red border for selected (anxious) */
            filter: grayscale(0); 
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
            transform: scale(1.05);
        }
        
        /* Styling for the custom slider */
        .rating-controls {
            padding-top: 0.5rem;
            width: 100%;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease-in-out;
        }
        .rating-controls.visible {
            opacity: 1;
            max-height: 100px; 
            padding-top: 1rem;
        }
        .rating-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0; 
            border-radius: 4px;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6d28d9; 
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .rating-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6d28d9; 
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .slider-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6d28d9;
            text-align: center;
            margin-top: 2px;
        }
        
        .gallery-item {
            width: 100%;
            /* 保持高度限制 */
            height: 80px; 
            object-fit: cover;
            border-radius: 0.5rem;
            border: 3px solid transparent;
            transition: all 0.2s;
            opacity: 1; 
        }
        .gallery-item.filtered {
            border-color: #d32f2f;
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
        }
        .gallery-item.safe {
            border-color: #388e3c;
            opacity: 0.7;
        }
        #loading-message {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .hidden-item {
            display: none !important;
        }
        .hidden-page {
            display: none;
        }
        .hidden-step {
            display: none;
        }
        .disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-300 via-pink-300 to-purple-400 min-h-screen flex flex-col justify-center items-center p-4">

    <div id="main-container" class="container text-center relative">
        <button id="fullscreen-toggle-button" class="absolute top-4 right-4 bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-1 px-3 rounded-full transition-all text-xs z-10">
            全螢幕模式
        </button>
        
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Appearance Anxiety Filter</h1>
        <p class="text-sm text-gray-500 mb-6">透過設定個人化過濾器，保護您的心理健康</p>
        
        <!-- Setting Page (Page 1) -->
        <div id="settings-page">
            
            <button id="go-to-gallery-button-top" class="bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-2 px-8 rounded-full transition-all w-full mb-4 text-sm">
                前往圖庫 (設定完成後跳轉)
            </button>
            
            <!-- Personal Info Section -->
            <div class="mb-4">
                <div class="section-title">您的基本資料</div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <select id="age-input" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的年齡</option>
                        <option value="10-19">10-19歲</option>
                        <option value="20-29">20-29歲</option>
                        <option value="30-39">30-39歲</option>
                        <option value="40-49">40-49歲</option>
                        <option value="50-59">50-59歲</option>
                        <option value="60+">60歲以上</option>
                    </select>
                    <select id="gender-select" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的性別</option>
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>

            <!-- Body Parts and Size Input Wrapper (Responsive Grid) -->
            <div class="md:grid md:grid-cols-2 md:gap-6 mb-6">
                <!-- Body Parts Section (Left/Top) -->
                <div>
                    <div class="section-title">在意的身體部位</div>
                    <div id="body-parts-container" class="checkbox-container mt-4">
                        <label data-part="face">
                            <input type="checkbox" class="hidden" value="face" />
                            <span class="checkbox-label">臉</span>
                        </label>
                        <label data-part="legs">
                            <input type="checkbox" class="hidden" value="legs" />
                            <span class="checkbox-label">腿</span>
                        </label>
                        <label data-part="chest">
                            <input type="checkbox" class="hidden" value="chest" />
                            <span class="checkbox-label">胸部</span>
                        </label>
                        <label data-part="waist">
                            <input type="checkbox" class="hidden" value="waist" />
                            <span class="checkbox-label">腰</span>
                        </label>
                        <label data-part="buttocks">
                            <input type="checkbox" class="hidden" value="buttocks" />
                            <span class="checkbox-label">臀部</span>
                        </label>
                    </div>
                </div>
                
                <!-- Size Input Section (Right/Bottom) -->
                <div id="size-input-section" class="hidden mt-6 md:mt-0">
                    <div class="section-title">輸入部位尺寸</div>
                    <div id="size-input-container" class="size-input-container">
                    </div>
                </div>
            </div>

            <!-- Anxiety Example Upload Section -->
            <div class="mb-6">
                <div class="section-title">上傳讓你感到焦慮的單張圖片 (選填)</div>
                <label for="anxiety-example-upload" class="file-box">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                    </svg>
                    <span id="anxiety-example-label-text">點擊上傳讓您焦慮的單張範例圖片</span>
                    <input type="file" id="anxiety-example-upload" accept="image/*" class="hidden"/>
                </label>
                <p id="anxiety-example-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳範例圖片。
                </p>
            </div>

            <!-- New Topic Filter Section -->
            <div class="mb-6">
                <div class="section-title">過濾主題</div>
                <div class="mt-4">
                    <input type="text" id="topic-input" placeholder="輸入您想要過濾的主題關鍵字 (如: 瘦身, 健美, 網紅)" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" />
                </div>
            </div>

            <!-- BOTTOM MAIN ACTION BUTTON -->
            <button id="start-filter-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4">
                開始進行篩選 (準備實驗)
            </button>
            
        </div>
        
        <!-- Experiment Page (Page 2) - MULTI-STEP -->
        <div id="experiment-page" class="hidden-page">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">實驗：評估圖片焦慮程度 
                (<span id="set-counter">第 1 / 3 組</span>)
            </h2>

            <button id="back-to-settings-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-all text-sm mb-4 w-full">
                ← 返回設定頁
            </button>
            
            <div id="experiment-loading-message" class="hidden mb-4">
                <div id="loading-message">正在準備實驗內容...</div>
            </div>

            <!-- STEP 1: Image Selection Instruction -->
            <div id="step-selection-instruction" class="mb-6 p-4 border border-purple-300 rounded-lg bg-purple-50">
                <div class="section-title text-purple-700">步驟一：選出最焦慮的 3 張圖片</div>
                <p class="text-sm text-gray-700 mt-2 text-left">
                    請在以下圖片中，「點擊」選出讓您感到容貌焦慮最強烈的「3張」圖片。
                    <span class="font-bold block mt-1 text-red-600" id="selection-status-text">您已選擇 0 張 / 需選擇 3 張</span>
                </p>
            </div>

            <!-- STEP 2: Rating Instruction (Initially Hidden) -->
            <div id="step-rating-instruction" class="hidden mb-6 p-4 border border-purple-300 rounded-lg bg-purple-50">
                <div class="section-title text-purple-700">步驟二：評估所有圖片的焦慮強度 (1-7分)</div>
                <p class="text-sm text-gray-700 mt-2 text-left">
                    請對以下 9 張圖片逐一評估其引發您**容貌焦慮的強度**。
                    <span class="font-bold block mt-1 text-red-600">您在步驟一選出的 3 張圖片已用紅框標註。</span>
                </p>
            </div>
            
            <!-- 9-Image Grid for Selection / Rating (grid-cols-3) -->
            <div id="experiment-selection-grid" class="mb-6 grid grid-cols-3 gap-3">
                <!-- 9 image wrappers will be inserted here -->
            </div>

            <!-- Buttons -->
            <button id="go-to-rating-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-6 disabled-button" disabled>
                進入評分步驟 (已選擇 0/3)
            </button>
            
            <!-- This button handles BOTH moving to next set OR finishing the experiment -->
            <button id="next-set-button" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-6">
                進入下一組實驗 (第 2 / 3 組)
            </button>
            
        </div>

        <!-- NEW: Thank You Page (Page 4) -->
        <div id="thankyou-page" class="hidden-page">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">
                謝謝您的填答，實驗已經結束
            </h2>

            <div class="p-6 bg-purple-50 rounded-xl border border-purple-300 shadow-md">
                <p class="text-lg text-purple-700 font-semibold mb-3">
                    感謝您的參與！
                </p>
                <p class="text-base text-gray-700 mb-4">
                    您的個人化設定以及實驗數據已成功記錄，這對於我們訓練更符合您需求的容貌焦慮 AI 過濾器至關重要。
                </p>
                <p class="text-sm text-gray-600 font-medium">
                    您現在可以回到設定頁面，或查看 AI 根據您的設定所模擬的過濾結果。
                </p>
            </div>

            <!-- MODIFIED: Changed the main action button -->
            <div class="mt-8 space-y-4">
                <button id="back-to-settings-from-thankyou" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full">
                    返回設定頁面
                </button>
            </div>
            
            <!-- NEW: Small link to the gallery -->
            <button id="go-to-gallery-from-thankyou-small" class="text-sm text-purple-600 mt-4 hover:underline disabled-button" disabled>
                或點此查看 AI 過濾結果 (圖庫)
            </button>
        </div>
        
        <!-- Gallery Results Page (Page 3) -->
        <div id="gallery-page" class="hidden-page">
            
            <button id="back-from-gallery-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-all text-sm mb-4 w-full">
                ← 返回致謝頁
            </button>

            <!-- Gallery Image Upload Section (Hidden when coming from experiment) -->
            <div class="mb-6">
                <div class="section-title">上傳您的模擬圖庫照片 (建議 200 張)</div>
                <label for="gallery-upload" class="file-box gallery-upload-style">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12l-4.5 4.5m0 0l-4.5-4.5m4.5 4.5V3" />
                    </svg>
                    <span id="gallery-upload-label-text">點擊上傳多張照片到模擬圖庫</span>
                    <input type="file" id="gallery-upload" accept="image/*" class="hidden" multiple/>
                </label>
                <p id="gallery-upload-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳任何圖片。
                </p>
            </div>
            
            <!-- Run Filter Button - now repurposed -->
            <button id="show-full-results-button" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4 disabled-button" disabled>
                顯示完整 AI 過濾結果
            </button>


            <!-- Image Gallery -->
            <div id="gallery-container" class="mb-6">
                <div class="section-title" id="gallery-title">社群媒體內容模擬 (預設佔位圖)</div>
                <p class="text-xs text-gray-500 mt-2 text-left">紅色邊框為 AI 預測可能引起您焦慮的圖片；綠色邊框為安全內容。</p>
                <div id="image-gallery" class="gallery mt-4">
                    <!-- Placeholder images or uploaded images will be inserted here -->
                </div>
            </div>
            
            <div id="feedback-message" class="hidden feedback"></div>
            
            <!-- Confirm Filter Button -->
            <button id="confirm-filter-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-4">
                確定過濾，只顯示安全照片
            </button>
        </div>
    </div>

    <script>
        const API_KEY = ""; // Canvas will provide this in runtime
        // const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY; // 移除全域 API_URL

        const MAX_IMAGE_COUNT = 200; 
        const MAX_EXPERIMENT_SETS = 3; // 總共三組實驗
        const IMAGES_PER_SET = 9; // 每組 9 張圖片
        const MAX_SELECTION = 3; // 每組選 3 張

        let uploadedGalleryDataUrls = []; // Stores the 200 image data URLs (real or placeholder)
        let globalClassificationResults = null; // Stores the AI's classification [0, 1, 0, ...] for 200 images

        // --- Globals for Multi-Set Experiment ---
        // { name: "Set 1", setImages: [{indexInGallery: N, isFiltered: 0|1, dataUrl: string}], selections: [mapIndex], ratings: [1-7] }
        let experimentDataSets = []; 
        let currentSetIndex = 0; // 0, 1, or 2

        // --- HTML Elements ---
        const mainContainer = document.getElementById('main-container');
        const settingsPage = document.getElementById('settings-page');
        const experimentPage = document.getElementById('experiment-page');
        const galleryPage = document.getElementById('gallery-page');
        const thankyouPage = document.getElementById('thankyou-page'); // Renamed from summaryPage
        
        const backToSettingsButton = document.getElementById('back-to-settings-button');
        const backFromGalleryButton = document.getElementById('back-from-gallery-button'); 

        // Thank You Elements (UPDATED)
        const backToSettingsFromThankYouButton = document.getElementById('back-to-settings-from-thankyou');
        const goToGalleryFromThankYouSmall = document.getElementById('go-to-gallery-from-thankyou-small');
        
        // SET COUNTER
        const setCounter = document.getElementById('set-counter');

        // Experiment Step Elements
        const stepSelectionInstruction = document.getElementById('step-selection-instruction');
        const stepRatingInstruction = document.getElementById('step-rating-instruction');
        const experimentSelectionGrid = document.getElementById('experiment-selection-grid'); 
        const goToRatingButton = document.getElementById('go-to-rating-button');
        const selectionStatusText = document.getElementById('selection-status-text');
        const experimentLoadingMessage = document.getElementById('experiment-loading-message');
        const nextSetButton = document.getElementById('next-set-button'); 

        const bodyPartsContainer = document.getElementById('body-parts-container');
        const sizeInputSection = document.getElementById('size-input-section');
        const sizeInputContainer = document.getElementById('size-input-container');
        const topicInput = document.getElementById('topic-input');
        const anxietyExampleUpload = document.getElementById('anxiety-example-upload');
        const anxietyExampleStatus = document.getElementById('anxiety-example-status');
        const anxietyExampleLabelText = document.getElementById('anxiety-example-label-text');
        
        const galleryUpload = document.getElementById('gallery-upload'); 
        const galleryUploadStatus = document.getElementById('gallery-upload-status'); 
        const galleryUploadLabelText = document.getElementById('gallery-upload-label-text'); 
        
        const goToGalleryButtonTop = document.getElementById('go-to-gallery-button-top');
        const startFilterButton = document.getElementById('start-filter-button'); 
        const fullscreenToggleButton = document.getElementById('fullscreen-toggle-button'); 

        const showFullResultsButton = document.getElementById('show-full-results-button');
        const feedbackMessage = document.getElementById('feedback-message');
        const imageGallery = document.getElementById('image-gallery');
        const ageInput = document.getElementById('age-input');
        const genderSelect = document.getElementById('gender-select');
        const confirmFilterButton = document.getElementById('confirm-filter-button');
        const galleryTitle = document.getElementById('gallery-title');

        // --- UTILITY FUNCTIONS ---
        
        function showPage(pageId) {
            settingsPage.classList.add('hidden-page');
            experimentPage.classList.add('hidden-page');
            galleryPage.classList.add('hidden-page');
            thankyouPage.classList.add('hidden-page'); // Updated variable name
            mainContainer.classList.remove('gallery-view');
            
            if (pageId === 'settings-page') {
                settingsPage.classList.remove('hidden-page');
            } else if (pageId === 'experiment-page') {
                experimentPage.classList.remove('hidden-page');
            } else if (pageId === 'gallery-page') {
                galleryPage.classList.remove('hidden-page');
                mainContainer.classList.add('gallery-view');
            } else if (pageId === 'thankyou-page') { // Updated ID
                thankyouPage.classList.remove('hidden-page');
                // Ensure the gallery link is enabled if results exist
                const isReady = !!globalClassificationResults;
                goToGalleryFromThankYouSmall.disabled = !isReady;
                goToGalleryFromThankYouSmall.classList.toggle('disabled-button', !isReady);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function generatePlaceholderDataUrls(count) {
             const dataUrls = [];
             const tags = ['美食', '旅遊', '健身', '網美', '時尚', '風景', '寵物', '日常'];
             for (let i = 0; i < count; i++) {
                const width = 150;
                const height = 150;
                const tag = tags[Math.floor(Math.random() * tags.length)];
                
                const text = `Content-${tag}-${i}`; 
                const color_bg = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                const color_text = 'ffffff';

                dataUrls.push(`https://placehold.co/${width}x${height}/${color_bg}/${color_text}?text=${text}`);
            }
            return dataUrls;
        }

        function renderGalleryImages() {
            imageGallery.innerHTML = ''; 

            const imagesToRender = uploadedGalleryDataUrls.length > 0 
                ? uploadedGalleryDataUrls 
                : generatePlaceholderDataUrls(MAX_IMAGE_COUNT);
            
            const renderCount = imagesToRender.length;

            for (let i = 0; i < renderCount; i++) {
                const imgElement = document.createElement('img');
                imgElement.src = imagesToRender[i];
                imgElement.className = 'gallery-item transition-all duration-300';
                imgElement.setAttribute('data-index', i);
                imageGallery.appendChild(imgElement);
            }
            galleryTitle.textContent = `社群媒體內容模擬 (共 ${renderCount} 張圖片)`;
        }
        
        // --- EVENT HANDLERS (File Input, UI Logic) ---

        anxietyExampleUpload.addEventListener('change', () => {
             // ... [File upload logic]
            const fileCount = anxietyExampleUpload.files.length;
            if (fileCount > 0) {
                anxietyExampleStatus.textContent = `已選擇 1 張範例圖片 (${anxietyExampleUpload.files[0].name})。`;
                anxietyExampleStatus.classList.remove('text-gray-500');
                anxietyExampleStatus.classList.add('text-pink-700');
                anxietyExampleLabelText.textContent = `範例圖片已選取: ${anxietyExampleUpload.files[0].name}`;
            } else {
                anxietyExampleStatus.textContent = `尚未上傳範例圖片。`;
                anxietyExampleStatus.classList.add('text-gray-500');
                anxietyExampleStatus.classList.remove('text-pink-700');
                anxietyExampleLabelText.textContent = '點擊上傳讓您焦慮的單張範例圖片';
            }
        });

        galleryUpload.addEventListener('change', async () => {
            const files = Array.from(galleryUpload.files).slice(0, MAX_IMAGE_COUNT);
            uploadedGalleryDataUrls = [];

            if (files.length > 0) {
                galleryUploadStatus.textContent = `正在讀取 ${files.length} 張圖片...`;
                
                try {
                    const promises = files.map(file => readFileAsDataUrl(file));
                    uploadedGalleryDataUrls = await Promise.all(promises);

                    galleryUploadStatus.textContent = `已成功讀取 ${uploadedGalleryDataUrls.length} 張圖片到圖庫。`;
                    galleryUploadLabelText.textContent = `重新上傳圖片 (已選 ${uploadedGalleryDataUrls.length} 張)`;
                } catch (error) {
                    galleryUploadStatus.textContent = `讀取圖片時發生錯誤。`;
                    console.error("Error reading gallery files:", error);
                }
            } else {
                galleryUploadStatus.textContent = `尚未上傳任何圖片。`;
                galleryUploadLabelText.textContent = '點擊上傳多張照片到模擬圖庫';
            }
            renderGalleryImages();
        });
        
        const partLabels = {
            'legs': '腿圍 (公分)',
            'chest': '胸圍 (公分)',
            'waist': '腰圍 (公分)',
            'buttocks': '臀圍 (公分)'
        };

        const generateSizeInput = (part) => {
            if (part === 'face') {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">臉部細項</label>
                    <div id="face-options" class="checkbox-container mt-2">
                        <label data-part="face-eyes">
                            <input type="checkbox" class="hidden" value="eyes" />
                            <span class="checkbox-label">眼睛</span>
                        </label>
                        <label data-part="face-nose">
                            <input type="checkbox" class="hidden" value="nose" />
                            <span class="checkbox-label">鼻子</span>
                        </label>
                        <label data-part="face-lips-main">
                            <input type="checkbox" class="hidden" value="lips" />
                            <span class="checkbox-label">嘴唇</span>
                        </label>
                        <label data-part="face-acne">
                            <input type="checkbox" class="hidden" value="acne" />
                            <span class="checkbox-label">痘痘</span>
                        </label>
                    </div>
                    <div id="lips-options-container" class="ml-4 mt-2 hidden">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">嘴唇細項</label>
                        <div class="checkbox-container mt-2">
                            <label data-part="lips-sub">
                                <input type="checkbox" class="hidden" value="full_lips" />
                                <span class="checkbox-label">豐唇</span>
                            </label>
                            <label data-part="lips-sub">
                                <input type="checkbox" class="hidden" value="thin_lips" />
                                <span class="checkbox-label">薄唇</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (part === 'waist') {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">選擇您的焦慮類型</label>
                    <select id="waist-anxiety-type" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>請選擇</option>
                        <option value="too_fat">擔心自己太胖 (尋找比自己細的腰)</option>
                        <option value="too_thin">擔心自己太瘦 (尋找比自己壯碩的腰)</option>
                    </select>
                    <label class="block text-left text-sm font-medium text-gray-700 mt-2">${partLabels[part]}</label>
                    <input type="number" placeholder="請輸入數值" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" data-part="${part}" />
                `;
            } else {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">${partLabels[part]}</label>
                    <input type="number" placeholder="請輸入數值" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" data-part="${part}" />
                `;
            }
        };

        const updateSizeInputs = () => {
            const checkedParts = Array.from(document.querySelectorAll('#body-parts-container input[type="checkbox"]:checked')).map(cb => cb.value);
            sizeInputContainer.innerHTML = '';
            
            if (checkedParts.length > 0) {
                sizeInputSection.classList.remove('hidden');
                checkedParts.forEach(part => {
                    const div = document.createElement('div');
                    div.innerHTML = generateSizeInput(part);
                    sizeInputContainer.appendChild(div);
                });
            } else {
                sizeInputSection.classList.add('hidden');
            }
        };

        bodyPartsContainer.addEventListener('change', updateSizeInputs);

        sizeInputContainer.addEventListener('change', (event) => {
            const input = event.target;
            if (input.type === 'checkbox' && input.value === 'lips') {
                const lipsOptionsContainer = document.getElementById('lips-options-container');
                if (lipsOptionsContainer) {
                    if (input.checked) {
                        lipsOptionsContainer.classList.remove('hidden');
                    } else {
                        Array.from(lipsOptionsContainer.querySelectorAll('input[type="checkbox"]')).forEach(subCb => {
                            subCb.checked = false;
                        });
                        lipsOptionsContainer.classList.add('hidden');
                    }
                }
            }
        });
        
        // --- GEMINI API 呼叫邏輯 ---

        async function processAnxietyExample(imageData) {
             const prompt = `請分析這張圖片的容貌特徵，這些特徵被使用者視為引起焦慮的『完美』樣貌。請只列出關鍵詞，例如: 極致纖細的腰部; 飽滿豐唇; 無瑕疵肌膚; 立體五官; 健美肌肉。請用分號分隔，不要超過 50 個字。`;
             
             const [header, base64Data] = imageData.src.split(',');
             const mimeTypeMatch = header.match(/:(.*?);/);
             const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/jpeg';

             try {
                const description = await callGeminiApi(prompt, true, mimeType, base64Data);
                return description.trim() || '未成功提取焦慮範例特徵';
            } catch (error) {
                console.error("Error generating anxiety description:", error);
                return '提取焦慮範例特徵時發生錯誤';
            }
        }
        
        async function callGeminiApi(prompt, isImage=false, mimeType="image/jpeg", imageData=null, generationConfig=null) {
            
            const modelName = "gemini-2.5-flash-preview-05-20";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`; // 動態建構 API URL

            let payload = {};
            let contents = [];

            if (isImage && imageData) {
                contents = [
                    {
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: imageData
                                }
                            }
                        ]
                    }
                ];
            } else {
                contents = [
                    {
                        parts: [
                            { text: prompt }
                        ]
                    }
                ];
            }
            
            payload.contents = contents;
            if (generationConfig) {
                 payload.generationConfig = generationConfig;
            }

            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 401 || response.status === 403) {
                         // 針對 401/403 認證錯誤進行額外記錄
                         console.error(`Authentication Error ${response.status}: API Key is likely invalid or missing. Ensure API_KEY is set to "" for Canvas injection.`);
                         throw new Error(`API authentication error: ${response.status}`);
                    }
                    if (response.status === 429) { 
                        throw new Error('Rate limit exceeded');
                    }
                    if (!response.ok) {
                        throw new Error(`API response error: ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    return result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                } catch (error) {
                    if (currentRetry === maxRetries - 1 || error.message.includes('Rate limit exceeded') === false) {
                         throw error; 
                    }
                    const delay = Math.pow(2, currentRetry) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    currentRetry++;
                }
            }
            return ''; 
        }
        
        async function runAiClassification() {
            let anxietyReferenceDescription = '無焦慮範例圖片';
            const exampleFiles = anxietyExampleUpload.files;

            if (exampleFiles.length > 0) {
                try {
                    const exampleImageData = { src: await readFileAsDataUrl(exampleFiles[0]) };
                    anxietyReferenceDescription = await processAnxietyExample(exampleImageData);
                } catch (error) {
                    console.error("Error processing anxiety example:", error);
                    anxietyReferenceDescription = '提取焦慮範例特徵時發生錯誤，已略過。';
                }
            }
            
            const age = ageInput.value || '未選擇';
            const gender = genderSelect.value || '未選擇';
            
            const concerns = [];
            document.querySelectorAll('#body-parts-container input[type="checkbox"]:checked').forEach(cb => {
                const part = cb.value;
                if (part !== 'face') {
                    const inputElement = document.querySelector(`input[data-part="${part}"]`);
                    const size = inputElement ? inputElement.value : null;
                    
                    if (part === 'waist') {
                        const waistAnxietyType = document.getElementById('waist-anxiety-type')?.value;
                        let detail = `腰圍: ${size || '未輸入'} 公分`;
                        if (waistAnxietyType) {
                            if (waistAnxietyType === 'too_fat') {
                                detail += '，焦慮類型: 擔心過胖，需篩選出視覺上更細、更纖瘦的腰部圖片。';
                            } else if (waistAnxietyType === 'too_thin') {
                                detail += '，焦慮類型: 擔心過瘦，需篩選出視覺上更壯碩、更健美的腰部圖片。';
                            }
                        }
                        if (size || waistAnxietyType) { 
                            concerns.push(detail);
                        }
                    } else if (size) {
                         concerns.push(partLabels[part] + ': ' + size + ' 公分');
                    }
                } else if (part === 'face') {
                    const faceOptions = Array.from(document.querySelectorAll('#face-options input:checked')).map(fcb => fcb.value);
                    let lipsOptions = [];
                    if (faceOptions.includes('lips')) {
                         const lipsOptionsContainer = document.getElementById('lips-options-container');
                         if (lipsOptionsContainer) {
                            lipsOptions = Array.from(lipsOptionsContainer.querySelectorAll('input:checked')).map(lcb => lcb.value);
                            lipsOptions = lipsOptions.filter(val => val === 'full_lips' || val === 'thin_lips');
                         }
                    }
                    const cleanedFaceOptions = faceOptions.filter(val => val !== 'lips');
                    const allFaceConcerns = [...cleanedFaceOptions, ...lipsOptions].join(', ');
                    if (allFaceConcerns) {
                        concerns.push('臉部細項: ' + allFaceConcerns);
                    }
                }
            });

            const concernText = concerns.join('; ') || '未選擇焦慮特徵';
            const topic = topicInput.value || '無';
            const totalImages = uploadedGalleryDataUrls.length || MAX_IMAGE_COUNT;
            
            const simulationPrompt = `
                請您扮演一個社群媒體 AI 濾鏡系統。
                現在有 ${totalImages} 張模擬的社群媒體圖片內容。
                請根據以下使用者的「容貌焦慮」設定，模擬分析這 ${totalImages} 張圖片，並決定哪些圖片會被過濾掉。
                
                使用者設定：
                - 年齡：${age}
                - 性別：${gender}
                - **在意的身體部位及尺寸/細項**：${concernText}
                - 過濾主題：${topic}
                - 焦慮範例特徵 (AI提取)：${anxietyReferenceDescription}
                
                模擬過濾原則：
                - 約有 25% 的圖片應該被標記為「可能引起焦慮」 (1)。
                - 標記為 (1) 的圖片應該與使用者的「在意部位/尺寸/主題/焦慮範例特徵」有高度相關性。
                - 標記為 (0) 的圖片應屬於普通、健康、與焦慮無關的內容。

                請直接以 JSON 陣列格式輸出 ${totalImages} 個結果。陣列中每個元素必須是數字 0 (安全) 或 1 (過濾)。
            `;
            
            const simulationSchema = {
                type: "ARRAY",
                items: {
                    type: "INTEGER",
                    enum: [0, 1]
                }
            };
            
            try {
                const resultText = await callGeminiApi(
                    simulationPrompt, 
                    false, 
                    null, 
                    null, 
                    {
                        responseMimeType: "application/json",
                        responseSchema: simulationSchema
                    }
                );
                
                const result = JSON.parse(resultText);
                if (Array.isArray(result) && result.length === totalImages) {
                    return result;
                }
                throw new Error("AI returned unexpected result format or length.");

            } catch (error) {
                console.error('Error simulating filtering:', error);
                
                console.warn("使用隨機分類結果作為預覽/錯誤處理，以確保實驗頁面能正常顯示。");
                return Array.from({ length: totalImages }, () => Math.random() < 0.25 ? 1 : 0);
            }
        }
        
        // --- Experiment Setup and Data Handling ---

        function setupExperimentSets(classificationResults) {
            experimentDataSets = [];
            currentSetIndex = 0;
            
            const allImages = uploadedGalleryDataUrls.length > 0 
                ? uploadedGalleryDataUrls 
                : generatePlaceholderDataUrls(MAX_IMAGE_COUNT);
                
            const totalCount = classificationResults.length;
            const filteredIndices = classificationResults.map((status, index) => status === 1 ? index : -1).filter(index => index !== -1);
            const safeIndices = classificationResults.map((status, index) => status === 0 ? index : -1).filter(index => index !== -1);
            
            // 需要 9 張 Anxious 圖片 和 18 張 Safe 圖片 (3 Anxious + 6 Safe per set)
            const requiredAnxious = 3 * MAX_EXPERIMENT_SETS;
            const requiredSafe = 6 * MAX_EXPERIMENT_SETS;
            
            // 確保有足夠的圖片
            const selectedAnxiousIndices = filteredIndices.sort(() => 0.5 - Math.random()).slice(0, requiredAnxious);
            const selectedSafeIndices = safeIndices.sort(() => 0.5 - Math.random()).slice(0, requiredSafe);
            
            if (selectedAnxiousIndices.length < requiredAnxious || selectedSafeIndices.length < requiredSafe) {
                 console.warn(`警告: AI分類結果中焦慮/安全圖片不足。已使用所有可用的圖片 (焦慮: ${selectedAnxiousIndices.length}, 安全: ${selectedSafeIndices.length}) 來填滿實驗組。`);
            }
            
            for (let i = 0; i < MAX_EXPERIMENT_SETS; i++) {
                const setAnxious = selectedAnxiousIndices.slice(i * 3, (i + 1) * 3);
                const setSafe = selectedSafeIndices.slice(i * 6, (i + 1) * 6);
                
                // Shuffle within the set of indices
                const setIndices = [...setAnxious, ...setSafe].sort(() => 0.5 - Math.random());
                
                const setImages = setIndices.map(index => ({
                    indexInGallery: index,
                    isFiltered: classificationResults[index],
                    dataUrl: allImages[index]
                }));
                
                experimentDataSets.push({
                    name: `Set ${i + 1}`,
                    setImages: setImages, // The 9 images for this set
                    selections: [], // User's 3 selections (mapIndex 0-8)
                    ratings: Array(IMAGES_PER_SET).fill(4) // User's 9 ratings (1-7) (Default to 4)
                });
            }
        }
        
        function prepareExperimentPage(setIndex) {
            
            if (setIndex >= MAX_EXPERIMENT_SETS || experimentDataSets.length === 0) {
                 console.error("嘗試渲染不存在的實驗組或實驗數據為空。");
                 return;
            }
            
            const currentSetData = experimentDataSets[setIndex];
            
            // 1. UI Status Update
            setCounter.textContent = `第 ${setIndex + 1} / ${MAX_EXPERIMENT_SETS} 組`;
            stepSelectionInstruction.classList.remove('hidden');
            stepRatingInstruction.classList.add('hidden');
            goToRatingButton.classList.remove('hidden');
            nextSetButton.classList.add('hidden');
            
            // 2. Render Images
            experimentSelectionGrid.innerHTML = '';
            
            currentSetData.setImages.forEach((imgData, mapIndex) => {
                const wrapperDiv = document.createElement('div');
                wrapperDiv.className = 'selection-wrapper';
                wrapperDiv.setAttribute('data-map-index', mapIndex);

                const imgElement = document.createElement('img');
                imgElement.src = imgData.dataUrl;
                imgElement.className = 'experiment-item selection-item w-full h-auto rounded-lg object-cover aspect-square shadow-md hover:shadow-xl'; 
                imgElement.setAttribute('alt', `Selection Image ${mapIndex + 1}`);

                wrapperDiv.appendChild(imgElement);
                experimentSelectionGrid.appendChild(wrapperDiv);
            });
            
            // 3. Reset Selection/Rating state and listener
            currentSetData.selections = [];
            currentSetData.ratings = Array(IMAGES_PER_SET).fill(4); // Reset ratings

            updateSelectionStatus();
            setupSelectionListener();
        }

        function updateSelectionStatus() {
            const currentSetData = experimentDataSets[currentSetIndex];
            const selectedCount = currentSetData.selections.length;
            selectionStatusText.textContent = `您已選擇 ${selectedCount} 張 / 需選擇 ${MAX_SELECTION} 張`;

            const isReady = selectedCount === MAX_SELECTION;
            goToRatingButton.disabled = !isReady;
            goToRatingButton.classList.toggle('disabled-button', !isReady);
            goToRatingButton.textContent = isReady ? '進入評分步驟' : `進入評分步驟 (已選擇 ${selectedCount}/${MAX_SELECTION})`;

            // Update visual state of images
            document.querySelectorAll('.selection-wrapper').forEach(wrapper => {
                const mapIndex = parseInt(wrapper.getAttribute('data-map-index'));
                if (currentSetData.selections.includes(mapIndex)) {
                    wrapper.classList.add('selected');
                } else {
                    wrapper.classList.remove('selected');
                }
            });
        }
        
        function setupSelectionListener() {
            document.querySelectorAll('.selection-wrapper').forEach(wrapper => {
                wrapper.onclick = (event) => {
                    const currentSetData = experimentDataSets[currentSetIndex];
                    const mapIndex = parseInt(wrapper.getAttribute('data-map-index'));
                    const isSelected = currentSetData.selections.includes(mapIndex);

                    if (isSelected) {
                        // Deselect
                        currentSetData.selections = currentSetData.selections.filter(index => index !== mapIndex);
                    } else {
                        // Select (if not maxed out)
                        if (currentSetData.selections.length < MAX_SELECTION) {
                            currentSetData.selections.push(mapIndex);
                        } else {
                            // Optionally, automatically replace the oldest selection
                            // currentSetData.selections.shift();
                            // currentSetData.selections.push(mapIndex);
                        }
                    }
                    updateSelectionStatus();
                };
            });
        }
        
        function setupRatingView() {
            const currentSetData = experimentDataSets[currentSetIndex];
            
            // Change instructions and button visibility
            stepSelectionInstruction.classList.add('hidden');
            stepRatingInstruction.classList.remove('hidden');
            goToRatingButton.classList.add('hidden');
            
            if (currentSetIndex < MAX_EXPERIMENT_SETS - 1) {
                nextSetButton.textContent = `進入下一組實驗 (第 ${currentSetIndex + 2} / ${MAX_EXPERIMENT_SETS} 組)`;
                nextSetButton.classList.remove('hidden');
            } else {
                nextSetButton.textContent = '完成所有實驗';
                nextSetButton.classList.remove('hidden');
            }

            // Render ratings controls below images
            document.querySelectorAll('.selection-wrapper').forEach((wrapper, mapIndex) => {
                const initialRating = currentSetData.ratings[mapIndex];
                
                // Add Rating Controls (Slider and label)
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'rating-controls visible';
                controlsDiv.innerHTML = `
                    <label class="block text-xs font-medium text-gray-700 mb-1">焦慮強度評分 (1-7)</label>
                    <input type="range" min="1" max="7" value="${initialRating}" class="rating-slider" data-map-index="${mapIndex}">
                    <div class="flex justify-between text-xs mt-1 text-gray-500 font-medium">
                        <!-- UPDATED TEXT HERE -->
                        <span>1 (完全不焦慮)</span>
                        <span>${initialRating}</span>
                        <span>7 (極度焦慮)</span>
                    </div>
                `;
                
                const slider = controlsDiv.querySelector('.rating-slider');
                const labelContainer = controlsDiv.querySelector('.justify-between span:nth-child(2)');
                
                // Update the rating state on input
                slider.oninput = (event) => {
                    const value = parseInt(event.target.value);
                    labelContainer.textContent = value;
                    currentSetData.ratings[mapIndex] = value;
                };

                wrapper.appendChild(controlsDiv);
                wrapper.onclick = null; // Disable selection click
            });
        }
        
        // --- Navigation and Action Listeners ---
        
        fullscreenToggleButton.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
                fullscreenToggleButton.textContent = '退出全螢幕';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                fullscreenToggleButton.textContent = '全螢幕模式';
            }
        });

        startFilterButton.addEventListener('click', async () => {
             // 1. Show Loading
             experimentLoadingMessage.classList.remove('hidden');
             startFilterButton.disabled = true;
             startFilterButton.textContent = '正在進行 AI 模擬分析...';
             
             // 2. AI Simulation
             globalClassificationResults = await runAiClassification();
             
             // 3. Setup Experiment
             setupExperimentSets(globalClassificationResults);
             
             // 4. Navigate
             experimentLoadingMessage.classList.add('hidden');
             showPage('experiment-page');
             prepareExperimentPage(currentSetIndex);
             
             // 5. Reset Button State
             startFilterButton.disabled = false;
             startFilterButton.textContent = '開始進行篩選 (準備實驗)';
        });
        
        goToGalleryButtonTop.addEventListener('click', () => {
            if (globalClassificationResults) {
                showPage('gallery-page');
            } else {
                 // Simulate default results if jumping directly
                 runAiClassification().then(results => {
                    globalClassificationResults = results;
                    renderGalleryResults();
                    showFullResultsButton.disabled = false;
                    showFullResultsButton.classList.remove('disabled-button');
                    backFromGalleryButton.textContent = '← 返回設定頁';
                    showPage('gallery-page');
                }).catch(() => {
                    // Fallback to viewing the gallery without filtering applied
                    showPage('gallery-page');
                    backFromGalleryButton.textContent = '← 返回設定頁';
                });
            }
        });

        backToSettingsButton.addEventListener('click', () => {
            showPage('settings-page');
        });
        
        backToSettingsFromThankYouButton.addEventListener('click', () => {
            showPage('settings-page');
        });
        
        goToGalleryFromThankYouSmall.addEventListener('click', () => {
            renderGalleryResults();
            showPage('gallery-page');
        });

        backFromGalleryButton.addEventListener('click', () => {
            // Check where we came from. If experiment completed, go to thankyou. If direct jump, go to settings.
            if (currentSetIndex === MAX_EXPERIMENT_SETS) {
                showPage('thankyou-page');
            } else {
                 // If we haven't started or completed the experiment, go back to settings
                showPage('settings-page');
            }
            confirmFilterButton.classList.add('hidden'); // Ensure the confirmation button is hidden when returning
        });

        goToRatingButton.addEventListener('click', () => {
            setupRatingView();
        });
        
        nextSetButton.addEventListener('click', () => {
            currentSetIndex++;
            if (currentSetIndex < MAX_EXPERIMENT_SETS) {
                prepareExperimentPage(currentSetIndex);
            } else {
                // Experiment finished
                currentSetIndex = MAX_EXPERIMENT_SETS; // Mark as finished
                
                // TEMP: For a real app, send all experimentDataSets to the backend here!
                console.log("Experiment Finished! All data collected:", experimentDataSets);
                
                // Navigate to Thank You Page
                showPage('thankyou-page');
            }
        });
        
        showFullResultsButton.addEventListener('click', () => {
             renderGalleryResults();
        });
        
        confirmFilterButton.addEventListener('click', () => {
             document.querySelectorAll('.gallery-item').forEach((img, index) => {
                const isFiltered = globalClassificationResults[index] === 1;
                img.classList.toggle('hidden-item', isFiltered);
             });
             feedbackMessage.textContent = '已過濾掉所有 AI 判定可能引起您焦慮的內容。';
             feedbackMessage.classList.remove('hidden', 'negative');
             feedbackMessage.classList.add('positive');
             confirmFilterButton.classList.add('hidden');
        });
        
        // --- Gallery Results Rendering ---

        function renderGalleryResults() {
            if (!globalClassificationResults) {
                feedbackMessage.textContent = '錯誤：尚未執行 AI 模擬分析。請先返回設定頁進行分析。';
                feedbackMessage.classList.remove('hidden', 'positive');
                feedbackMessage.classList.add('negative');
                document.getElementById('image-gallery').innerHTML = '';
                return;
            }
            
            // Ensure images are rendered before applying styles
            renderGalleryImages();

            document.querySelectorAll('.gallery-item').forEach((img, index) => {
                const status = globalClassificationResults[index];
                
                img.classList.remove('filtered', 'safe', 'hidden-item');

                if (status === 1) {
                    img.classList.add('filtered'); // Red border for anxious
                } else {
                    img.classList.add('safe'); // Green border for safe
                }
            });
            
            feedbackMessage.classList.add('hidden');
            confirmFilterButton.classList.remove('hidden');
            showFullResultsButton.disabled = true;
            showFullResultsButton.classList.add('disabled-button');
        }

        // --- Initialization ---

        window.onload = () => {
            // Initial render of placeholder images in the gallery
            renderGalleryImages();
            
            // Set initial state
            showPage('settings-page'); 
        };
    </script>
</body>
</html>
