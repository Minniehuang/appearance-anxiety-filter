<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appearance Anxiety Filter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto+Sans+TC', sans-serif;
            background: linear-gradient(135deg, #a7e2e3, #e2a7e3);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 1.5rem;
            max-width: 500px; /* 預設手機寬度 */
            width: 95%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: max-width 0.3s;
        }
        /* 調整容器在桌面或平板上的最大寬度以容納兩欄佈局 */
        @media (min-width: 768px) {
            .container {
                max-width: 768px; 
            }
        }
        /* 調整圖庫頁面的最大寬度以容納更多圖片 */
        .container.gallery-view {
            max-width: 800px;
        }
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 50%;
            height: 4px;
            background-color: #6d28d9;
            border-radius: 2px;
        }
        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        .checkbox-label {
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        input[type="checkbox"]:checked + .checkbox-label {
            background-color: #6d28d9;
            border-color: #6d28d9;
            color: #fff;
            box-shadow: 0 4px 10px rgba(109, 40, 217, 0.2);
        }
        /* Styling for file input boxes */
        .file-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            border: 2px dashed #a855f7;
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #6d28d9;
            font-weight: 600;
            margin-top: 1rem;
        }
        .file-box:hover {
            background-color: #f3e8ff;
        }
        .file-box.gallery-upload-style {
            background-color: #f3e8ff;
            border-color: #6d28d9;
        }
        .file-box.gallery-upload-style:hover {
            background-color: #f2e1ff;
        }
        .file-box svg {
            width: 2rem;
            height: 2rem;
            margin-bottom: 0.5rem;
        }
        /* End of styling for file input boxes */


        .slogan {
            font-style: italic;
            font-weight: 700;
            color: #6d28d9;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            font-size: 1.125rem;
        }
        .size-input-container {
            margin-top: 1rem;
            display: grid;
            gap: 1rem;
        }
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
        }
        .feedback.positive {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        .feedback.negative {
            background-color: #ffcdd2;
            color: #d32f2f;
        }
        .gallery {
            /* 調整 grid 讓圖庫在寬螢幕下顯示更多欄位 */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .gallery-item {
            width: 100%;
            height: 80px; /* 圖片高度調整 */
            object-fit: cover;
            border-radius: 0.5rem;
            border: 3px solid transparent;
            transition: all 0.2s;
            opacity: 1; 
        }
        .gallery-item.filtered {
            border-color: #d32f2f;
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
        }
        .gallery-item.safe {
            border-color: #388e3c;
            opacity: 0.7;
        }
        #loading-message {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .hidden-item {
            display: none !important;
        }
        /* 隱藏頁面 */
        .hidden-page {
            display: none;
        }
        .disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-300 via-pink-300 to-purple-400 min-h-screen flex flex-col justify-center items-center p-4">

    <div id="main-container" class="container text-center relative">
        <!-- NEW: Fullscreen Toggle Button -->
        <button id="fullscreen-toggle-button" class="absolute top-4 right-4 bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-1 px-3 rounded-full transition-all text-xs z-10">
            全螢幕模式
        </button>
        
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Appearance Anxiety Filter - 模擬應用</h1>
        <p class="text-sm text-gray-500 mb-6">透過設定個人化濾鏡，保護您的心理健康</p>
        
        <!-- Setting Page (Page 1) -->
        <div id="settings-page">
            
            <!-- NEW: TOP NAVIGATION BUTTON -->
            <button id="go-to-gallery-button-top" class="bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-2 px-8 rounded-full transition-all w-full mb-4 text-sm">
                前往模擬圖庫 (設定完成後跳轉)
            </button>
            
            <!-- Personal Info Section -->
            <div class="mb-4">
                <div class="section-title">您的基本資料</div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <select id="age-input" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的年齡</option>
                        <option value="10-19">10-19歲</option>
                        <option value="20-29">20-29歲</option>
                        <option value="30-39">30-39歲</option>
                        <option value="40-49">40-49歲</option>
                        <option value="50-59">50-59歲</option>
                        <option value="60+">60歲以上</option>
                    </select>
                    <select id="gender-select" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的性別</option>
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>

            <!-- Body Parts and Size Input Wrapper (Responsive Grid) -->
            <div class="md:grid md:grid-cols-2 md:gap-6 mb-6">
                <!-- Body Parts Section (Left/Top) -->
                <div>
                    <div class="section-title">在意的身體部位</div>
                    <div id="body-parts-container" class="checkbox-container mt-4">
                        <label data-part="face">
                            <input type="checkbox" class="hidden" value="face" />
                            <span class="checkbox-label">臉</span>
                        </label>
                        <label data-part="legs">
                            <input type="checkbox" class="hidden" value="legs" />
                            <span class="checkbox-label">腿</span>
                        </label>
                        <label data-part="chest">
                            <input type="checkbox" class="hidden" value="chest" />
                            <span class="checkbox-label">胸部</span>
                        </label>
                        <label data-part="waist">
                            <input type="checkbox" class="hidden" value="waist" />
                            <span class="checkbox-label">腰</span>
                        </label>
                        <label data-part="buttocks">
                            <input type="checkbox" class="hidden" value="buttocks" />
                            <span class="checkbox-label">臀部</span>
                        </label>
                    </div>
                </div>
                
                <!-- Size Input Section (Right/Bottom) -->
                <div id="size-input-section" class="hidden mt-6 md:mt-0">
                    <div class="section-title">輸入部位尺寸</div>
                    <div id="size-input-container" class="size-input-container">
                    </div>
                </div>
            </div>

            <!-- Anxiety Example Upload Section (Kept as optional reference for AI) -->
            <div class="mb-6">
                <div class="section-title">上傳讓你感到焦慮的單張圖片 (選填)</div>
                <label for="anxiety-example-upload" class="file-box">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                    </svg>
                    <span id="anxiety-example-label-text">點擊上傳讓您焦慮的單張範例圖片</span>
                    <input type="file" id="anxiety-example-upload" accept="image/*" class="hidden"/>
                </label>
                <p id="anxiety-example-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳範例圖片。
                </p>
            </div>

            <!-- New Topic Filter Section -->
            <div class="mb-6">
                <div class="section-title">過濾主題</div>
                <div class="mt-4">
                    <input type="text" id="topic-input" placeholder="輸入您想要過濾的主題關鍵字 (如: 瘦身, 健美, 網紅)" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" />
                </div>
            </div>

            <!-- NEW: BOTTOM MAIN ACTION BUTTON -->
            <button id="start-filter-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4">
                開始進行篩選
            </button>
            
        </div>
        
        <!-- Gallery Results Page (Page 2) -->
        <div id="gallery-page" class="hidden-page">
            
            <button id="back-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-all text-sm mb-4 w-full">
                ← 返回設定頁
            </button>

            <!-- MOVED: Gallery Image Upload Section -->
            <div class="mb-6">
                <div class="section-title">上傳您的模擬圖庫照片 (建議 200 張)</div>
                <label for="gallery-upload" class="file-box gallery-upload-style">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12l-4.5 4.5m0 0l-4.5-4.5m4.5 4.5V3" />
                    </svg>
                    <span id="gallery-upload-label-text">點擊上傳多張照片到模擬圖庫</span>
                    <input type="file" id="gallery-upload" accept="image/*" class="hidden" multiple/>
                </label>
                <p id="gallery-upload-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳任何圖片。
                </p>
            </div>
            
            <!-- New Run Filter Button -->
            <button id="run-filter-button" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4 disabled-button" disabled>
                開始 AI 篩選
            </button>


            <!-- Image Gallery -->
            <div id="gallery-container" class="mb-6">
                <div class="section-title" id="gallery-title">社群媒體內容模擬 (預設佔位圖)</div>
                <p class="text-xs text-gray-500 mt-2 text-left">紅色邊框為 AI 預測可能引起您焦慮的圖片；綠色邊框為安全內容。</p>
                <div id="image-gallery" class="gallery mt-4">
                    <!-- Placeholder images or uploaded images will be inserted here -->
                </div>
            </div>
            
            <div id="loading-message" class="hidden">
                <p>正在分析中，請稍候...</p>
            </div>
            
            <div id="feedback-message" class="hidden feedback"></div>
            
            <!-- Confirm Filter Button -->
            <button id="confirm-filter-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-4">
                確定過濾，只顯示安全照片
            </button>
        </div>
    </div>

    <script>
        const API_KEY = ""; // Canvas will provide this in runtime
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;

        // ** 模擬圖庫設定，固定數量為 200 張 **
        const MAX_IMAGE_COUNT = 200; 
        
        // ** 儲存上傳的圖片檔案 (Data URL) **
        let uploadedGalleryDataUrls = []; 

        // --- HTML Elements ---
        const mainContainer = document.getElementById('main-container');
        const settingsPage = document.getElementById('settings-page');
        const galleryPage = document.getElementById('gallery-page');
        const backButton = document.getElementById('back-button');
        
        const bodyPartsContainer = document.getElementById('body-parts-container');
        const sizeInputSection = document.getElementById('size-input-section');
        const sizeInputContainer = document.getElementById('size-input-container');
        const topicInput = document.getElementById('topic-input');
        const anxietyExampleUpload = document.getElementById('anxiety-example-upload');
        const anxietyExampleStatus = document.getElementById('anxiety-example-status');
        const anxietyExampleLabelText = document.getElementById('anxiety-example-label-text');
        
        const galleryUpload = document.getElementById('gallery-upload'); 
        const galleryUploadStatus = document.getElementById('gallery-upload-status'); 
        const galleryUploadLabelText = document.getElementById('gallery-upload-label-text'); 
        
        // UPDATED ELEMENT ID
        const goToGalleryButtonTop = document.getElementById('go-to-gallery-button-top');
        const startFilterButton = document.getElementById('start-filter-button'); 
        const fullscreenToggleButton = document.getElementById('fullscreen-toggle-button'); // NEW ELEMENT

        const runFilterButton = document.getElementById('run-filter-button'); // Gallery Page Button

        const feedbackMessage = document.getElementById('feedback-message');
        const imageGallery = document.getElementById('image-gallery');
        const ageInput = document.getElementById('age-input');
        const genderSelect = document.getElementById('gender-select');
        const loadingMessage = document.getElementById('loading-message');
        const confirmFilterButton = document.getElementById('confirm-filter-button');
        const galleryTitle = document.getElementById('gallery-title');

        // --- UTILITY FUNCTIONS ---
        
        /**
         * 切換顯示的頁面
         * @param {string} pageId - 'settings-page' or 'gallery-page'
         */
        function showPage(pageId) {
            if (pageId === 'settings-page') {
                settingsPage.classList.remove('hidden-page');
                galleryPage.classList.add('hidden-page');
                mainContainer.classList.remove('gallery-view');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (pageId === 'gallery-page') {
                settingsPage.classList.add('hidden-page');
                galleryPage.classList.remove('hidden-page');
                mainContainer.classList.add('gallery-view');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // -------------------------------------------------------------
        // --- 1. 檔案讀取及狀態更新 ---
        // -------------------------------------------------------------

        // Function to read file as Data URL
        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result); // Resolve with Data URL
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Update anxiety example status display
        anxietyExampleUpload.addEventListener('change', () => {
            const fileCount = anxietyExampleUpload.files.length;
            if (fileCount > 0) {
                anxietyExampleStatus.textContent = `已選擇 1 張範例圖片 (${anxietyExampleUpload.files[0].name})。`;
                anxietyExampleStatus.classList.remove('text-gray-500');
                anxietyExampleStatus.classList.add('text-pink-700');
                anxietyExampleLabelText.textContent = `範例圖片已選取: ${anxietyExampleUpload.files[0].name}`;
            } else {
                anxietyExampleStatus.textContent = `尚未上傳範例圖片。`;
                anxietyExampleStatus.classList.add('text-gray-500');
                anxietyExampleStatus.classList.remove('text-pink-700');
                anxietyExampleLabelText.textContent = '點擊上傳讓您焦慮的單張範例圖片';
            }
        });

        // Gallery Image Upload Handler
        galleryUpload.addEventListener('change', async () => {
            const files = Array.from(galleryUpload.files).slice(0, MAX_IMAGE_COUNT);
            uploadedGalleryDataUrls = [];

            if (files.length > 0) {
                galleryUploadStatus.textContent = `正在讀取 ${files.length} 張圖片...`;
                galleryUploadStatus.classList.remove('text-gray-500');
                galleryUploadStatus.classList.add('text-purple-700');
                
                try {
                    const promises = files.map(file => readFileAsDataUrl(file));
                    uploadedGalleryDataUrls = await Promise.all(promises);

                    galleryUploadStatus.textContent = `已成功讀取 ${uploadedGalleryDataUrls.length} 張圖片到圖庫。`;
                    galleryUploadLabelText.textContent = `重新上傳圖片 (已選 ${uploadedGalleryDataUrls.length} 張)`;
                    
                    // 啟用篩選按鈕
                    runFilterButton.disabled = false;
                    runFilterButton.classList.remove('disabled-button');

                } catch (error) {
                    galleryUploadStatus.textContent = `讀取圖片時發生錯誤。`;
                    console.error("Error reading gallery files:", error);
                    runFilterButton.disabled = true;
                    runFilterButton.classList.add('disabled-button');
                }
            } else {
                galleryUploadStatus.textContent = `尚未上傳任何圖片。`;
                galleryUploadStatus.classList.add('text-gray-500');
                galleryUploadStatus.classList.remove('text-purple-700');
                galleryUploadLabelText.textContent = '點擊上傳多張照片到模擬圖庫';
                
                // 如果沒有上傳圖片，則禁用篩選按鈕
                runFilterButton.disabled = true;
                runFilterButton.classList.add('disabled-button');
            }

            // 無論是否上傳，都重新渲染畫廊以顯示更新後的內容
            renderGalleryImages();
        });

        // -------------------------------------------------------------
        // --- 2. 畫廊渲染邏輯 ---
        // -------------------------------------------------------------

        /**
         * 根據上傳的圖片或預設的佔位符渲染畫廊
         */
        function renderGalleryImages() {
            imageGallery.innerHTML = ''; // 清空畫廊

            const imagesToRender = uploadedGalleryDataUrls.length > 0 
                ? uploadedGalleryDataUrls 
                : generatePlaceholderDataUrls(MAX_IMAGE_COUNT);
            
            const renderCount = imagesToRender.length;

            for (let i = 0; i < renderCount; i++) {
                const imgElement = document.createElement('img');
                imgElement.src = imagesToRender[i];
                imgElement.className = 'gallery-item transition-all duration-300';
                imgElement.setAttribute('data-index', i); // 標記索引以便後續篩選
                imageGallery.appendChild(imgElement);
            }
            galleryTitle.textContent = `社群媒體內容模擬 (共 ${renderCount} 張圖片)`;
        }

        /**
         * 產生預設的 Data URL 陣列 (只有在沒有上傳圖片時才使用)
         */
        function generatePlaceholderDataUrls(count) {
             const dataUrls = [];
             for (let i = 0; i < count; i++) {
                const width = 150;
                const height = 150;
                const tags = ['美食', '旅遊', '健身', '網美', '時尚', '風景', '寵物', '日常'];
                const tag = tags[Math.floor(Math.random() * tags.length)];
                
                const text = `Content-${tag}-${i}`; 
                const color_bg = Math.floor(Math.random()*16777215).toString(16);
                const color_text = 'ffffff';

                // 使用 placehold.co 生成 URL
                dataUrls.push(`https://placehold.co/${width}x${height}/${color_bg}/${color_text}?text=${text}`);
            }
            return dataUrls;
        }

        // 頁面載入時立即生成預設圖庫
        window.onload = function() {
            renderGalleryImages();
        };

        // -------------------------------------------------------------
        // --- 3. 尺寸輸入和 UI 邏輯 ---
        // -------------------------------------------------------------

        const partLabels = {
            'legs': '腿圍 (公分)',
            'chest': '胸圍 (公分)',
            'waist': '腰圍 (公分)',
            'buttocks': '臀圍 (公分)'
        };

        const generateSizeInput = (part) => {
            if (part === 'face') {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">臉部細項</label>
                    <div id="face-options" class="checkbox-container mt-2">
                        <label data-part="face-eyes">
                            <input type="checkbox" class="hidden" value="eyes" />
                            <span class="checkbox-label">眼睛</span>
                        </label>
                        <label data-part="face-nose">
                            <input type="checkbox" class="hidden" value="nose" />
                            <span class="checkbox-label">鼻子</span>
                        </label>
                        <label data-part="face-lips-main">
                            <input type="checkbox" class="hidden" value="lips" />
                            <span class="checkbox-label">嘴唇</span>
                        </label>
                        <label data-part="face-acne">
                            <input type="checkbox" class="hidden" value="acne" />
                            <span class="checkbox-label">痘痘</span>
                        </label>
                    </div>
                    <div id="lips-options-container" class="ml-4 mt-2 hidden">
                        <label class="block text-left text-sm font-medium text-gray-700 mt-2">嘴唇細項</label>
                        <div class="checkbox-container mt-2">
                            <label data-part="lips">
                                <input type="checkbox" class="hidden" value="full_lips" />
                                <span class="checkbox-label">豐唇</span>
                            </label>
                            <label data-part="lips">
                                <input type="checkbox" class="hidden" value="thin_lips" />
                                <span class="checkbox-label">薄唇</span>
                            </label>
                        </div>
                    </div>
                `;
            } else if (part === 'waist') {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">選擇您的焦慮類型</label>
                    <select id="waist-anxiety-type" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>請選擇</option>
                        <option value="too_fat">擔心自己太胖 (尋找比自己細的腰)</option>
                        <option value="too_thin">擔心自己太瘦 (尋找比自己壯碩的腰)</option>
                    </select>
                    <label class="block text-left text-sm font-medium text-gray-700 mt-2">${partLabels[part]}</label>
                    <input type="number" placeholder="請輸入數值" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" data-part="${part}" />
                `;
            } else {
                return `
                    <label class="block text-left text-sm font-medium text-gray-700">${partLabels[part]}</label>
                    <input type="number" placeholder="請輸入數值" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" data-part="${part}" />
                `;
            }
        };

        const updateSizeInputs = () => {
            const checkedParts = Array.from(document.querySelectorAll('#body-parts-container input[type="checkbox"]:checked')).map(cb => cb.value);
            sizeInputContainer.innerHTML = '';
            
            if (checkedParts.length > 0) {
                sizeInputSection.classList.remove('hidden');
                checkedParts.forEach(part => {
                    const div = document.createElement('div');
                    div.innerHTML = generateSizeInput(part);
                    sizeInputContainer.appendChild(div);
                });
            } else {
                sizeInputSection.classList.add('hidden');
            }
        };

        // Main Body Part change listener
        bodyPartsContainer.addEventListener('change', updateSizeInputs);

        // Delegation for lips sub-options (since they are added dynamically)
        sizeInputContainer.addEventListener('change', (event) => {
            const input = event.target;
            // Check if the input is a checkbox and its value is 'lips' (main lips option)
            if (input.type === 'checkbox' && input.value === 'lips') {
                const lipsOptionsContainer = document.getElementById('lips-options-container');
                if (lipsOptionsContainer) {
                    if (input.checked) {
                        lipsOptionsContainer.classList.remove('hidden');
                    } else {
                        lipsOptionsContainer.classList.add('hidden');
                    }
                }
            }
        });
        
        // -------------------------------------------------------------
        // --- 4. GEMINI API 呼叫邏輯 (維持不變) ---
        // -------------------------------------------------------------

        // Function to process the anxiety example image into a text description
        async function processAnxietyExample(imageData) {
             const prompt = `請分析這張圖片的容貌特徵，這些特徵被使用者視為引起焦慮的『完美』樣貌。請只列出關鍵詞，例如: 極致纖細的腰部; 飽滿豐唇; 無瑕疵肌膚; 立體五官; 健美肌肉。請用分號分隔，不要超過 50 個字。`;
             
             const [header, base64Data] = imageData.src.split(',');
             const mimeTypeMatch = header.match(/:(.*?);/);
             const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : 'image/jpeg';

             try {
                const description = await callGeminiApi(prompt, true, mimeType, base64Data);
                return description.trim() || '未成功提取焦慮範例特徵';
            } catch (error) {
                console.error("Error generating anxiety description:", error);
                return '提取焦慮範例特徵時發生錯誤';
            }
        }
        
        /**
         * 通用 Gemini API 呼叫函式
         */
        async function callGeminiApi(prompt, isImage=false, mimeType="image/jpeg", imageData=null, generationConfig=null) {
            let payload = {};
            let contents = [];

            if (isImage && imageData) {
                contents = [
                    {
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: imageData
                                }
                            }
                        ]
                    }
                ];
            } else {
                contents = [
                    {
                        parts: [
                            { text: prompt }
                        ]
                    }
                ];
            }
            
            payload.contents = contents;
            if (generationConfig) {
                 payload.generationConfig = generationConfig;
            }


            // Exponential Backoff implementation
            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.status === 429) { // Too Many Requests
                        throw new Error('Rate limit exceeded');
                    }
                    if (!response.ok) {
                        throw new Error(`API response error: ${response.status}: ${await response.text()}`);
                    }

                    const result = await response.json();
                    return result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                } catch (error) {
                    if (currentRetry === maxRetries - 1 || error.message.includes('Rate limit exceeded') === false) {
                         throw error; // Re-throw if it's the last attempt or a non-rate limit error
                    }
                    const delay = Math.pow(2, currentRetry) * 1000 + Math.random() * 1000;
                    console.warn(`Rate limit hit, retrying in ${Math.round(delay)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    currentRetry++;
                }
            }
            return ''; // Should not be reached
        }
        
        // -------------------------------------------------------------
        // --- 5. 按鈕事件邏輯 (已修改) ---
        // -------------------------------------------------------------

        // Page 1 Button: Navigate to Gallery Page (Top)
        goToGalleryButtonTop.addEventListener('click', function() {
            showPage('gallery-page');
            // 每次進入圖庫頁面，如果沒有上傳圖片，確保按鈕是禁用的
            if (uploadedGalleryDataUrls.length === 0) {
                 runFilterButton.disabled = true;
                 runFilterButton.classList.add('disabled-button');
            } else {
                 runFilterButton.disabled = false;
                 runFilterButton.classList.remove('disabled-button');
            }
        });

        // Page 1 Button: Navigate to Gallery Page (Bottom)
        startFilterButton.addEventListener('click', function() {
            showPage('gallery-page');
            // 每次進入圖庫頁面，如果沒有上傳圖片，確保按鈕是禁用的
            if (uploadedGalleryDataUrls.length === 0) {
                 runFilterButton.disabled = true;
                 runFilterButton.classList.add('disabled-button');
            } else {
                 runFilterButton.disabled = false;
                 runFilterButton.classList.remove('disabled-button');
            }
        });

        // Page 2 Button: Run Filter Logic
        runFilterButton.addEventListener('click', async function() {
            runFilterButton.disabled = true;
            runFilterButton.classList.add('disabled-button');
            loadingMessage.classList.remove('hidden');
            feedbackMessage.classList.add('hidden');
            confirmFilterButton.classList.add('hidden');
            
            // 重置所有圖片的狀態
            const allImages = imageGallery.querySelectorAll('.gallery-item');
            allImages.forEach(img => {
                img.classList.remove('filtered', 'safe', 'hidden-item');
                img.style.opacity = 1; 
                img.style.borderColor = 'transparent';
            });
            
            loadingMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });


            // --- STEP 1: Process Anxiety Example Image (if provided) ---
            let anxietyReferenceDescription = '無焦慮範例圖片';
            const exampleFiles = anxietyExampleUpload.files;

            if (exampleFiles.length > 0) {
                loadingMessage.innerHTML = '<p>正在分析您的焦慮範例圖片特徵...</p>';
                try {
                    // Note: We need to use the file from the original settings page input, which is still in memory.
                    const exampleImageData = { src: await readFileAsDataUrl(exampleFiles[0]) };
                    anxietyReferenceDescription = await processAnxietyExample(exampleImageData);
                } catch (error) {
                    loadingMessage.innerHTML = '<p>分析焦慮範例圖片失敗，將略過此步驟。</p>';
                }
            }


            // --- STEP 2: Collect user concerns ---
            loadingMessage.innerHTML = '<p>正在整理您的個人化過濾器參數...</p>';
            
            const age = ageInput.value || '未選擇';
            const gender = genderSelect.value || '未選擇';
            
            // Collect user concerns (size and sub-options) - logic remains the same
            const concerns = [];
            document.querySelectorAll('#body-parts-container input[type="checkbox"]:checked').forEach(cb => {
                const part = cb.value;
                
                // 處理尺寸輸入
                const inputElement = document.querySelector(`input[data-part="${part}"]`);
                const size = inputElement ? inputElement.value : null;

                if (part === 'face') {
                    const faceOptions = Array.from(document.querySelectorAll('#face-options input:checked')).map(fcb => fcb.value);
                    const lipsOptions = Array.from(document.querySelectorAll('#lips-options-container input:checked')).map(lcb => lcb.value);
                    const allFaceConcerns = [...faceOptions, ...lipsOptions].join(', ');
                    if (allFaceConcerns) {
                        concerns.push('臉部細項: ' + allFaceConcerns);
                    }
                } else if (part === 'waist') {
                    // 腰部特殊處理：結合尺寸和焦慮類型
                    const waistAnxietyType = document.getElementById('waist-anxiety-type')?.value;
                    let detail = `腰圍: ${size || '未輸入'} 公分`;
                    if (waistAnxietyType) {
                        if (waistAnxietyType === 'too_fat') {
                            detail += '，焦慮類型: 擔心過胖，需篩選出視覺上更細、更纖瘦的腰部圖片。';
                        } else if (waistAnxietyType === 'too_thin') {
                            detail += '，焦慮類型: 擔心過瘦，需篩選出視覺上更壯碩、更健美的腰部圖片。';
                        }
                    }
                    concerns.push(detail);
                } else if (size) {
                    // 其他部位尺寸
                     concerns.push(partLabels[part] + ': ' + size + ' 公分');
                }
            });

            
            const concernText = concerns.join('; ') || '未選擇焦慮特徵';
            const topic = topicInput.value || '無';
            
            // --- STEP 3: Call AI to simulate filtering results (Structured JSON Output) ---
            loadingMessage.innerHTML = '<p>正在發送模擬分析請求，請稍候...</p>';
            runFilterButton.textContent = `模擬分析中...`;
            
            const totalImages = allImages.length; // Use actual count
            
            // *** 這是關鍵：Prompt 中包含了所有的個人化標準，包括尺寸 ***
            const simulationPrompt = `
                請您扮演一個社群媒體 AI 濾鏡系統。
                現在有 ${totalImages} 張模擬的社群媒體圖片內容。
                請根據以下使用者的「容貌焦慮」設定，模擬分析這 ${totalImages} 張圖片，並決定哪些圖片會被過濾掉。
                
                使用者設定：
                - 年齡：${age}
                - 性別：${gender}
                - **在意的身體部位及尺寸/細項**：${concernText}
                - 過濾主題：${topic}
                - 焦慮範例特徵 (AI提取)：${anxietyReferenceDescription}
                
                模擬過濾原則：
                - 約有 25% 的圖片應該被標記為「可能引起焦慮」 (1)。
                - 標記為 (1) 的圖片應該與使用者的「在意部位/尺寸/主題/焦慮範例特徵」有高度相關性。例如：如果使用者輸入腰圍 60 公分且擔心過胖，則標記 (1) 的圖片應該是視覺上腰圍明顯小於 60 公分的極瘦腰部圖片。
                - 標記為 (0) 的圖片應屬於普通、健康、與焦慮無關的內容。

                請直接以 JSON 陣列格式輸出 ${totalImages} 個結果。陣列中每個元素必須是數字 0 (安全) 或 1 (過濾)。
                
                範例格式 (但請輸出 ${totalImages} 個元素)：[0, 1, 0, 0, 1, ...]
            `;
            
            const simulationSchema = {
                type: "ARRAY",
                items: {
                    type: "INTEGER",
                    enum: [0, 1]
                }
            };
            
            let simulationResult = null;
            let foundCount = 0;
            
            try {
                const resultText = await callGeminiApi(
                    simulationPrompt, 
                    false, // 不是圖片呼叫
                    null, 
                    null, 
                    {
                        responseMimeType: "application/json",
                        responseSchema: simulationSchema
                    }
                );
                
                simulationResult = JSON.parse(resultText);

            } catch (error) {
                console.error('Error simulating filtering:', error);
                loadingMessage.innerHTML = '<p>模擬分析失敗，請檢查您的輸入或稍後再試。</p>';
                runFilterButton.disabled = false;
                runFilterButton.classList.remove('disabled-button');
                runFilterButton.textContent = '開始 AI 篩選';
                return;
            }
            
            // --- STEP 4: Apply the simulated results to the gallery ---
            loadingMessage.innerHTML = '<p>正在應用過濾結果...</p>';
            
            if (simulationResult && Array.isArray(simulationResult) && simulationResult.length >= totalImages) {
                for (let i = 0; i < totalImages; i++) {
                    const imgElement = allImages[i];
                    const filterStatus = simulationResult[i]; // 0 或 1
                    
                    if (filterStatus === 1) {
                        imgElement.classList.add('filtered'); // 紅色邊框
                        foundCount++;
                    } else {
                        imgElement.classList.add('safe'); // 綠色邊框
                    }
                    imgElement.classList.remove('opacity-0');
                }
            } else {
                 console.error("AI returned unexpected result format or length.");
                 loadingMessage.innerHTML = '<p>AI 返回結果格式錯誤，無法應用過濾器。</p>';
            }

            // Final feedback update
            loadingMessage.classList.add('hidden');
            galleryTitle.textContent = 'AI 篩選結果：可能引起焦慮的照片 (紅框標註)'; 
            
            const finalFeedbackText = `在模擬的 ${totalImages} 張圖片中，找到了 ${foundCount} 張可能引起焦慮的圖片 (紅色邊框)。`;
            feedbackMessage.textContent = finalFeedbackText;
            feedbackMessage.classList.remove('hidden');

            if (foundCount > 0) {
                 feedbackMessage.classList.add('negative');
                 feedbackMessage.classList.remove('positive');
                 confirmFilterButton.classList.remove('hidden'); // Show the new button
            } else {
                 feedbackMessage.classList.add('positive');
                 feedbackMessage.classList.remove('negative');
                 confirmFilterButton.classList.add('hidden'); // Hide if nothing was found
            }
            
            runFilterButton.disabled = false;
            runFilterButton.classList.remove('disabled-button');
            runFilterButton.textContent = '重新開始 AI 篩選';
        });
        
        // --- Confirm Filter Button Logic ---
        confirmFilterButton.addEventListener('click', function() {
            let hiddenCount = 0;
            const images = imageGallery.querySelectorAll('.gallery-item');
            
            images.forEach(img => {
                if (img.classList.contains('filtered')) {
                    img.classList.add('hidden-item'); 
                    hiddenCount++;
                } else {
                    img.classList.remove('safe');
                    img.style.opacity = 1;
                    img.style.borderColor = 'transparent';
                }
            });

            galleryTitle.textContent = '已過濾結果：安全照片';
            
            feedbackMessage.textContent = `成功過濾了 ${hiddenCount} 張可能引起焦慮的圖片。目前只顯示安全照片。`;
            feedbackMessage.classList.add('positive');
            feedbackMessage.classList.remove('negative');
            
            confirmFilterButton.classList.add('hidden');
        });
        
        // --- Back Button Logic ---
        backButton.addEventListener('click', function() {
            showPage('settings-page');
        });

        // -------------------------------------------------------------
        // --- 6. 全螢幕切換邏輯 (NEW) ---
        // -------------------------------------------------------------
        
        function toggleFullscreen() {
            const docEl = document.documentElement;
            // 檢查是否處於全螢幕狀態
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;

            if (!isFullscreen) {
                // 進入全螢幕
                if (docEl.requestFullscreen) {
                    docEl.requestFullscreen();
                } else if (docEl.mozRequestFullScreen) { // Firefox
                    docEl.mozRequestFullScreen();
                } else if (docEl.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    docEl.webkitRequestFullscreen();
                } else if (docEl.msRequestFullscreen) { // IE/Edge
                    docEl.msRequestFullscreen();
                }
                // 按鈕文字會在 'fullscreenchange' 事件中更新，但為確保即時性，可以先更新
                fullscreenToggleButton.textContent = '退出全螢幕';
            } else {
                // 退出全螢幕
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
                fullscreenToggleButton.textContent = '全螢幕模式';
            }
        }

        // Add event listener to the new button
        if (fullscreenToggleButton) {
            fullscreenToggleButton.addEventListener('click', toggleFullscreen);

            // Update button text when full-screen state changes (e.g., user presses Esc)
            document.addEventListener('fullscreenchange', () => {
                 const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullscreenElement || document.msFullscreenElement;
                 fullscreenToggleButton.textContent = isFullscreen ? '退出全螢幕' : '全螢幕模式';
            });
            document.addEventListener('webkitfullscreenchange', () => {
                 const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullscreenElement || document.msFullscreenElement;
                 fullscreenToggleButton.textContent = isFullscreen ? '退出全螢幕' : '全螢幕模式';
            });
        }

        // 變換標語功能已移除
    </script>
</body>
</html>


