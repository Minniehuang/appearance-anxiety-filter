<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appearance Anxiety Filter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #a7e2e3, #e2a7e3);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 10vh;
            color: #333;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 1.5rem;
            max-width: 450px; 
            width: 95%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: max-width 0.3s;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 650px; 
            }
        }
        .container.gallery-view {
            max-width: 750px;
        }
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
        }
        .section-title::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 50%;
            height: 4px;
            background-color: #6d28d9;
            border-radius: 2px;
        }
        
        /* 臉部細項標題樣式 - 比選項文字 (0.875rem) 大 */
        .detail-option-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            color: #4c1d95; /* indigo-800 */
        }
        
        /* 臉部細項容器樣式 - 確保選項垂直排列並左對齊 */
        .face-detail-container {
            display: flex;
            flex-direction: column; /* 垂直堆疊 */
            gap: 0.5rem; 
        }

        /* 確保臉部選項的 pill 按鈕佔滿容器寬度，且文字左對齊 */
        .face-detail-container label {
            width: 100%;
        }

        .checkbox-label {
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 9999px;
            padding: 0.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem; 
            display: block; /* 確保 label 內的 span 是區塊元素 */
            width: 100%; /* 確保標籤寬度與其容器一致 */
        }
        /* 應用於臉部細項的 checkbox-label */
        .face-detail-container .checkbox-label {
            text-align: left; /* 確保文字左對齊 */
            padding-left: 1.5rem; /* 增加左邊距 */
        }

        input[type="checkbox"]:checked + .checkbox-label {
            background-color: #6d28d9;
            border-color: #6d28d9;
            color: #fff;
            box-shadow: 0 4px 10px rgba(109, 40, 217, 0.2);
        }
        
        .file-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            border: 2px dashed #a855f7;
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: #6d28d9;
            font-weight: 600;
            margin-top: 1rem;
        }
        .file-box:hover {
            background-color: #f3e8ff;
        }
        .file-box.gallery-upload-style {
            background-color: #f3e8ff;
            border-color: #6d28d9;
        }
        .file-box.gallery-upload-style:hover {
            background-color: #f2e1ff;
        }
        .file-box svg {
            width: 2rem;
            height: 2rem;
            margin-bottom: 0.5rem;
        }
        .slogan {
            font-style: italic;
            font-weight: 700;
            color: #6d28d9;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            font-size: 1.125rem;
        }
        .size-input-container {
            margin-top: 1rem;
            display: grid;
            gap: 1rem;
        }
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
        }
        .feedback.positive {
            background-color: #c8e6c9;
            color: #388e3c;
        }
        .feedback.negative {
            background-color: #ffcdd2;
            color: #d32f2f;
        }
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 0.6rem;
            margin-top: 1rem;
        }
        
        /* Experiment Item Styling */
        .selection-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .selection-item {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 3px solid transparent;
            transition: all 0.2s;
            filter: grayscale(0.5); 
            border-radius: 0.5rem;
        }
        .selection-wrapper.selected .selection-item {
            border-color: #ef4444; /* Red border for selected (anxious) */
            filter: grayscale(0); 
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
            transform: scale(1.05);
        }
        
        /* Styling for the custom slider */
        .rating-controls {
            padding-top: 0.5rem;
            width: 100%;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s ease-in-out;
        }
        .rating-controls.visible {
            opacity: 1;
            max-height: 100px; 
            padding-top: 1rem;
        }
        .rating-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0; 
            border-radius: 4px;
            cursor: pointer;
            margin: 0;
            padding: 0;
        }
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6d28d9; 
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .rating-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6d28d9; 
            cursor: pointer;
            border: 3px solid #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .slider-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6d28d9;
            text-align: center;
            margin-top: 2px;
        }
        
        .gallery-item {
            width: 100%;
            height: 80px; 
            object-fit: cover;
            border-radius: 0.5rem;
            border: 3px solid transparent;
            transition: all 0.2s;
            opacity: 1; 
        }
        .gallery-item.filtered {
            border-color: #d32f2f;
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
        }
        .gallery-item.safe {
            border-color: #388e3c;
            opacity: 0.7;
        }
        #loading-message {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .hidden-item {
            display: none !important;
        }
        .hidden-page {
            display: none;
        }
        .hidden-step {
            display: none;
        }
        .disabled-button {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-cyan-300 via-pink-300 to-purple-400 min-h-screen flex flex-col justify-center items-center p-4">

    <div id="main-container" class="container text-center relative">
        <button id="fullscreen-toggle-button" class="absolute top-4 right-4 bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-1 px-3 rounded-full transition-all text-xs z-10">
            全螢幕模式
        </button>
        
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Appearance Anxiety Filter</h1>
        <p class="text-sm text-gray-500 mb-6">透過設定個人化過濾器，保護您的心理健康</p>
        
        <!-- Setting Page (Page 1) -->
        <div id="settings-page">
            
            <button id="go-to-gallery-button-top" class="bg-purple-100 hover:bg-purple-200 text-purple-600 font-bold py-2 px-8 rounded-full transition-all w-full mb-4 text-sm">
                前往圖庫 (設定完成後跳轉)
            </button>
            
            <!-- Personal Info Section -->
            <div class="mb-4">
                <div class="section-title">您的基本資料</div>
                <div class="flex flex-col sm:flex-row gap-4 mt-4">
                    <select id="age-input" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的年齡</option>
                        <option value="10-19">10-19歲</option>
                        <option value="20-29">20-29歲</option>
                        <option value="30-39">30-39歲</option>
                        <option value="40-49">40-49歲</option>
                        <option value="50-59">50-59歲</option>
                        <option value="60+">60歲以上</option>
                    </select>
                    <select id="gender-select" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        <option value="" disabled selected>您的性別</option>
                        <option value="male">男性</option>
                        <option value="female">女性</option>
                        <option value="other">其他</option>
                    </select>
                </div>
            </div>

            <!-- Body Parts and Size Input Wrapper (Responsive Grid) -->
            <div class="md:grid md:grid-cols-2 md:gap-6 mb-6">
                <!-- Body Parts Section (Left/Top) -->
                <div>
                    <div class="section-title">您想達成的理想部位</div>
                    <!-- CHANGED: Replaced checkbox-container with flex flex-col space-y-2 for vertical stacking -->
                    <div id="body-parts-container" class="flex flex-col space-y-2 mt-4">
                        <label data-part="face" class="w-full">
                            <input type="checkbox" class="hidden" value="face" />
                            <span class="checkbox-label">臉</span>
                        </label>
                        <label data-part="legs" class="w-full">
                            <input type="checkbox" class="hidden" value="legs" />
                            <span class="checkbox-label">腿</span>
                        </label>
                        <label data-part="chest" class="w-full">
                            <input type="checkbox" class="hidden" value="chest" />
                            <span class="checkbox-label">胸部</span>
                        </label>
                        <label data-part="waist" class="w-full">
                            <input type="checkbox" class="hidden" value="waist" />
                            <span class="checkbox-label">腰</span>
                        </label>
                        <label data-part="buttocks" class="w-full">
                            <input type="checkbox" class="hidden" value="buttocks" />
                            <span class="checkbox-label">臀部</span>
                        </label>
                    </div>
                </div>
                
                <!-- Size Input Section (Right/Bottom) -->
                <div id="size-input-section" class="hidden mt-6 md:mt-0">
                    <div class="section-title">輸入理想的部位尺寸/細項</div>
                    <div id="size-input-container" class="size-input-container">
                    </div>
                </div>
            </div>

            <!-- Ideal Example Upload Section -->
            <div class="mb-6">
                <div class="section-title">上傳您的理想範例圖片 (選填)</div>
                <label for="anxiety-example-upload" class="file-box">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                    </svg>
                    <span id="anxiety-example-label-text">點擊上傳您的理想樣貌單張範例圖片</span>
                    <input type="file" id="anxiety-example-upload" accept="image/*" class="hidden"/>
                </label>
                <p id="anxiety-example-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳範例圖片。 (此圖將作為過濾器的正向參考)
                </p>
            </div>

            <!-- New Topic Filter Section -->
            <div class="mb-6">
                <div class="section-title">過濾主題</div>
                <div class="mt-4">
                    <input type="text" id="topic-input" placeholder="輸入您想要過濾的主題關鍵字 (如: 瘦身, 健美, 網紅)" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all" />
                </div>
            </div>

            <!-- VALIDATION FEEDBACK (New Element) -->
            <div id="settings-feedback" class="hidden feedback negative mb-4"></div>

            <!-- BOTTOM MAIN ACTION BUTTON -->
            <button id="start-filter-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4">
                開始進行篩選 (準備實驗)
            </button>
            
        </div>
        
        <!-- Experiment Page (Page 2) - MULTI-STEP -->
        <div id="experiment-page" class="hidden-page">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-2">實驗：評估圖片焦慮程度 
                (<span id="set-counter">第 1 / 3 組</span>)
            </h2>

            <button id="back-to-settings-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-all text-sm mb-4 w-full">
                ← 返回設定頁
            </button>
            
            <div id="experiment-loading-message" class="hidden mb-4">
                <div id="loading-message">正在準備實驗內容...</div>
            </div>

            <!-- STEP 1: Image Selection Instruction -->
            <div id="step-selection-instruction" class="mb-6 p-4 border border-purple-300 rounded-lg bg-purple-50">
                <div class="section-title text-purple-700">步驟一：選出最焦慮的 3 張圖片</div>
                <p class="text-sm text-gray-700 mt-2 text-left">
                    請在以下圖片中，**點擊** 選出讓您感到**容貌焦慮最強烈**的 **3 張** 圖片。
                    <span class="font-bold block mt-1 text-red-600" id="selection-status-text">您已選擇 0 張 / 需選擇 3 張</span>
                </p>
            </div>

            <!-- STEP 2: Rating Instruction (Initially Hidden) -->
            <div id="step-rating-instruction" class="hidden mb-6 p-4 border border-purple-300 rounded-lg bg-purple-50">
                <div class="section-title text-purple-700">步驟二：評估所有圖片的焦慮強度 (1-7分)</div>
                <p class="text-sm text-gray-700 mt-2 text-left">
                    請對以下 **9 張圖片** 逐一評估其引發您**容貌焦慮的強度**。
                    <span class="font-bold block mt-1 text-red-600">您在步驟一選出的 3 張圖片已用紅框標註。</span>
                </p>
            </div>
            
            <!-- 9-Image Grid for Selection / Rating (grid-cols-3) -->
            <div id="experiment-selection-grid" class="mb-6 grid grid-cols-3 gap-3">
                <!-- 9 image wrappers will be inserted here -->
            </div>

            <!-- Buttons -->
            <button id="go-to-rating-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-6 disabled-button" disabled>
                進入評分步驟 (已選擇 0/3)
            </button>
            
            <!-- This button handles BOTH moving to next set OR finishing the experiment -->
            <button id="next-set-button" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-6">
                進入下一組實驗 (第 2 / 3 組)
            </button>
            
        </div>
        
        <!-- Gallery Results Page (Page 3) -->
        <div id="gallery-page" class="hidden-page">
            
            <!-- Changed back to go to settings -->
            <button id="back-from-gallery-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full transition-all text-sm mb-4 w-full">
                ← 返回設定頁
            </button>

            <!-- Gallery Image Upload Section (Hidden when coming from experiment) -->
            <div class="mb-6">
                <div class="section-title">上傳您的模擬圖庫照片 (建議 200 張)</div>
                <label for="gallery-upload" class="file-box gallery-upload-style">
                    <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12l-4.5 4.5m0 0l-4.5-4.5m4.5 4.5V3" />
                    </svg>
                    <span id="gallery-upload-label-text">點擊上傳多張照片到模擬圖庫</span>
                    <input type="file" id="gallery-upload" accept="image/*" class="hidden" multiple/>
                </label>
                <p id="gallery-upload-status" class="text-xs text-left mt-2 text-gray-500">
                    尚未上傳任何圖片。
                </p>
            </div>
            
            <!-- Run Filter Button - now repurposed -->
            <button id="show-full-results-button" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mb-4 disabled-button" disabled>
                顯示完整 AI 過濾結果
            </button>


            <!-- Image Gallery -->
            <div id="gallery-container" class="mb-6">
                <div class="section-title" id="gallery-title">社群媒體內容模擬 (預設佔位圖)</div>
                <p class="text-xs text-gray-500 mt-2 text-left">紅色邊框為 AI 預測可能引起您焦慮的圖片；綠色邊框為安全內容。</p>
                <div id="image-gallery" class="gallery mt-4">
                    <!-- Placeholder images or uploaded images will be inserted here -->
                </div>
            </div>
            
            <div id="feedback-message" class="hidden feedback"></div>
            
            <!-- Confirm Filter Button -->
            <button id="confirm-filter-button" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg transform hover:scale-105 w-full mt-4">
                確定過濾，只顯示安全照片
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Firebase setup variables (MUST BE USED AS IS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app = null;
        let db = null;
        let auth = null;
        let userId = 'loading'; 
        let isAuthReady = false;

        // --- Global State ---
        const state = {
            selectedParts: [],
            detailInputs: {}, // Stores details and sizes: { waist: '30cm', face: ['jawline', 'nose'] }
            userInfo: {
                age: '',
                gender: '',
                topic: '',
            },
            anxietyExample: null, // Stores base64 image data for the ideal example
            galleryImages: [], // Stores uploaded or placeholder images for the gallery
            experimentData: [], // Stores results of 3 experiment sets
            currentSet: 1, // Current experiment set (1 to 3)
            imagesPerSet: 9, // Number of images per experiment set
            totalSets: 3,
            galleryFiltered: false,
        };

        // --- DOM Elements ---
        const settingsPage = document.getElementById('settings-page');
        const experimentPage = document.getElementById('experiment-page');
        const galleryPage = document.getElementById('gallery-page');
        
        // REMOVED thankyouPage element
        
        const bodyPartsContainer = document.getElementById('body-parts-container');
        const sizeInputSection = document.getElementById('size-input-section');
        const sizeInputContainer = document.getElementById('size-input-container');
        const settingsFeedback = document.getElementById('settings-feedback');
        const startFilterButton = document.getElementById('start-filter-button');
        const goRatingButton = document.getElementById('go-to-rating-button');
        const nextSetButton = document.getElementById('next-set-button');
        const experimentGrid = document.getElementById('experiment-selection-grid');
        const selectionStatusText = document.getElementById('selection-status-text');
        const setCounter = document.getElementById('set-counter');
        const galleryContainer = document.getElementById('image-gallery');
        const mainContainer = document.getElementById('main-container');

        // --- CONSTANTS ---
        // Placeholder images (simulating diverse social media content)
        const PLACEHOLDER_IMAGES = [
            'https://placehold.co/100x150/a7a7a7/ffffff?text=P1',
            'https://placehold.co/150x100/a7a7a7/ffffff?text=P2',
            'https://placehold.co/100x120/a7a7a7/ffffff?text=P3',
            'https://placehold.co/120x100/a7a7a7/ffffff?text=P4',
            'https://placehold.co/110x150/a7a7a7/ffffff?text=P5',
            'https://placehold.co/100x100/a7a7a7/ffffff?text=P6',
            'https://placehold.co/150x120/a7a7a7/ffffff?text=P7',
            'https://placehold.co/120x150/a7a7a7/ffffff?text=P8',
            'https://placehold.co/100x130/a7a7a7/ffffff?text=P9',
            'https://placehold.co/130x100/a7a7a7/ffffff?text=P10',
            'https://placehold.co/100x110/a7a7a7/ffffff?text=P11',
            'https://placehold.co/110x100/a7a7a7/ffffff?text=P12',
            'https://placehold.co/100x140/a7a7a7/ffffff?text=P13',
            'https://placehold.co/140x100/a7a7a7/ffffff?text=P14',
            'https://placehold.co/100x100/a7a7a7/ffffff?text=P15',
            'https://placehold.co/150x150/a7a7a7/ffffff?text=P16',
            'https://placehold.co/100x120/a7a7a7/ffffff?text=P17',
            'https://placehold.co/120x100/a7a7a7/ffffff?text=P18',
            'https://placehold.co/100x130/a7a7a7/ffffff?text=P19',
            'https://placehold.co/130x100/a7a7a7/ffffff?text=P20',
            'https://placehold.co/100x100/a7a7a7/ffffff?text=P21',
            'https://placehold.co/150x150/a7a7a7/ffffff?text=P22',
            'https://placehold.co/100x120/a7a7a7/ffffff?text=P23',
            'https://placehold.co/120x100/a7a7a7/ffffff?text=P24',
            'https://placehold.co/100x130/a7a7a7/ffffff?text=P25',
        ];
        
        // Image set indexes for the 3 sets (for placeholder images)
        const EXPERIMENT_SET_INDEXES = [
            [0, 1, 2, 3, 4, 5, 6, 7, 8],      // Set 1: Images P1-P9
            [9, 10, 11, 12, 13, 14, 15, 16, 17], // Set 2: Images P10-P18
            [18, 19, 20, 21, 22, 23, 24, 0, 1]  // Set 3: Images P19-P25 + P1, P2 (repeat to fill 9)
        ];

        // --- Firebase Initialization and Auth ---
        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }
            try {
                // Set Firestore log level for debugging
                setLogLevel('Debug'); 

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase initialized. User ID:", userId);
                        // Start listening for user's data once authenticated
                        listenToSettingsData(); 
                    } else {
                        // This should only happen if the initial sign-in fails
                        userId = crypto.randomUUID(); 
                        isAuthReady = true;
                        console.log("Signed in anonymously. Generated ID:", userId);
                    }
                });

            } catch (error) {
                console.error("Firebase setup error:", error);
                // Fallback to a random ID if Firebase fails completely
                userId = crypto.randomUUID();
                isAuthReady = true;
            }
        }

        // --- Firestore Data Operations ---

        /**
         * Get the reference to the user's private settings document.
         * @returns {object|null} Firestore Document Reference
         */
        const getUserSettingsRef = () => {
            if (!isAuthReady || !db) {
                console.error("Database or Auth not ready.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/settings/{settingsDoc}
            return doc(db, 
                'artifacts', appId, 
                'users', userId, 
                'settings', 'user_appearance_filter'
            );
        };

        /**
         * Saves the current application state (settings and experiment results) to Firestore.
         */
        const saveState = async () => {
            const settingsDocRef = getUserSettingsRef();
            if (!settingsDocRef) return;

            const dataToSave = {
                userInfo: state.userInfo,
                selectedParts: state.selectedParts,
                detailInputs: state.detailInputs,
                anxietyExample: state.anxietyExample, // Base64 data
                experimentData: state.experimentData,
                lastUpdated: new Date().toISOString(),
                userId: userId,
            };

            try {
                await setDoc(settingsDocRef, dataToSave, { merge: true });
                console.log("State saved successfully.");
            } catch (error) {
                console.error("Error saving state:", error);
            }
        };
        
        /**
         * Loads initial settings data from Firestore and updates the UI.
         * Uses onSnapshot for real-time updates (optional, but good practice).
         */
        const listenToSettingsData = () => {
            const settingsDocRef = getUserSettingsRef();
            if (!settingsDocRef) return;

            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    console.log("State loaded:", savedData);
                    
                    // Update state and UI based on loaded data
                    Object.assign(state.userInfo, savedData.userInfo || state.userInfo);
                    state.selectedParts = savedData.selectedParts || [];
                    state.detailInputs = savedData.detailInputs || {};
                    state.anxietyExample = savedData.anxietyExample || null;
                    state.experimentData = savedData.experimentData || [];
                    
                    // UI refresh
                    updateSettingsUI();
                    generateDetailInputs();
                    
                    // Determine current set based on existing data
                    // If all sets are complete, set currentSet to the total + 1
                    state.currentSet = state.experimentData.length >= state.totalSets 
                        ? state.totalSets + 1
                        : state.experimentData.length + 1;
                        
                    setCounter.textContent = `第 ${Math.min(state.currentSet, state.totalSets)} / ${state.totalSets} 組`;

                } else {
                    console.log("No saved settings found, starting fresh.");
                }
            }, (error) => {
                console.error("Error listening to settings:", error);
            });
        };

        // --- UI Update and Rendering ---

        /**
         * Updates the UI elements based on state.userInfo.
         */
        const updateSettingsUI = () => {
            document.getElementById('age-input').value = state.userInfo.age;
            document.getElementById('gender-select').value = state.userInfo.gender;
            document.getElementById('topic-input').value = state.userInfo.topic;

            // Update Body Parts Checkboxes
            document.querySelectorAll('#body-parts-container input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = state.selectedParts.includes(checkbox.value);
                checkbox.closest('label').classList.toggle('selected', checkbox.checked);
            });

            // Update Anxiety Example Status
            const exampleStatusText = document.getElementById('anxiety-example-status');
            const exampleLabelText = document.getElementById('anxiety-example-label-text');
            if (state.anxietyExample) {
                exampleStatusText.textContent = '已上傳理想範例圖片。';
                exampleLabelText.textContent = '點擊重新上傳理想範例圖片';
            } else {
                exampleStatusText.textContent = '尚未上傳範例圖片。 (此圖將作為過濾器的正向參考)';
                exampleLabelText.textContent = '點擊上傳您的理想樣貌單張範例圖片';
            }
        };

        /**
         * Generates the detailed input fields (Face details, Size inputs) based on selected parts.
         * *** Includes the user's requested change: use "理想樣貌" framing. ***
         */
        const generateDetailInputs = () => {
            const selectedParts = state.selectedParts;
            let html = '';
            
            // --- 1. Face Details (Checkbox list for desired features) ---
            if (selectedParts.includes('face')) {
                html += `
                    <div class="face-detail-container p-3 bg-white rounded-lg shadow-inner">
                        <p class="detail-option-title mb-2 text-left">臉部特徵：您想達成的理想樣貌</p>
                        
                        <label data-detail-type="face" data-detail-value="jawline">
                            <input type="checkbox" class="hidden" value="jawline" ${state.detailInputs.face?.includes('jawline') ? 'checked' : ''}/>
                            <span class="checkbox-label">稜角分明的下顎線 (Jawline)</span>
                        </label>
                        <label data-detail-type="face" data-detail-value="nose">
                            <input type="checkbox" class="hidden" value="nose" ${state.detailInputs.face?.includes('nose') ? 'checked' : ''}/>
                            <span class="checkbox-label">精緻挺拔的鼻樑 (Nose Bridge)</span>
                        </label>
                        <label data-detail-type="face" data-detail-value="eyes">
                            <input type="checkbox" class="hidden" value="eyes" ${state.detailInputs.face?.includes('eyes') ? 'checked' : ''}/>
                            <span class="checkbox-label">明亮有神的雙眼 (Bright Eyes)</span>
                        </label>
                        <label data-detail-type="face" data-detail-value="skin">
                            <input type="checkbox" class="hidden" value="skin" ${state.detailInputs.face?.includes('skin') ? 'checked' : ''}/>
                            <span class="checkbox-label">光滑無瑕的肌膚 (Flawless Skin)</span>
                        </label>
                    </div>
                `;
            }

            // --- 2. Size Inputs (Measurement inputs for desired size) ---
            
            // Waist (腰)
            if (selectedParts.includes('waist')) {
                const currentWaist = state.detailInputs.waist || '';
                html += `
                    <div class="p-3 bg-white rounded-lg shadow-inner">
                        <label for="waist-input" class="block text-sm font-medium text-gray-700 mb-2">腰圍尺寸 (公分/英寸):</label>
                        <input type="text" id="waist-input" data-part="waist" value="${currentWaist}" placeholder="您想達成的理想尺寸 (例如: 65cm)" 
                               class="w-full border border-gray-300 rounded-lg p-2 focus:ring-purple-500 focus:border-purple-500" />
                    </div>
                `;
            }

            // Legs (腿) - uses a general descriptor
            if (selectedParts.includes('legs')) {
                html += `
                    <div class="p-3 bg-white rounded-lg shadow-inner">
                        <p class="detail-option-title mb-2 text-left">腿部：您想達成的理想樣貌</p>
                        <label data-detail-type="legs" data-detail-value="slim-firm">
                            <input type="checkbox" class="hidden" value="slim-firm" ${state.detailInputs.legs?.includes('slim-firm') ? 'checked' : ''}/>
                            <span class="checkbox-label">苗條結實的大腿</span>
                        </label>
                        <label data-detail-type="legs" data-detail-value="long-straight">
                            <input type="checkbox" class="hidden" value="long-straight" ${state.detailInputs.legs?.includes('long-straight') ? 'checked' : ''}/>
                            <span class="checkbox-label">修長筆直的腿型</span>
                        </label>
                    </div>
                `;
            }

            // Other body parts (Chest and Buttocks - no specific details needed for this demo)


            // Update DOM
            sizeInputContainer.innerHTML = html;
            sizeInputSection.classList.toggle('hidden', html === '');
            
            // Re-attach listeners for the dynamically created detail inputs
            if (html !== '') {
                sizeInputContainer.querySelectorAll('input[type="checkbox"]').forEach(input => {
                    input.addEventListener('change', handleDetailCheckboxChange);
                });
                sizeInputContainer.querySelectorAll('input[type="text"]').forEach(input => {
                    input.addEventListener('input', handleSizeInputChange);
                });
            }
        };


        /**
         * Switches the current view between pages.
         * @param {string} pageId - The ID of the page to show.
         */
        const showPage = (pageId) => {
            // Removed thankyouPage
            const pages = [settingsPage, experimentPage, galleryPage];
            pages.forEach(page => page.classList.add('hidden-page'));
            
            document.getElementById(pageId).classList.remove('hidden-page');
            
            // Adjust container size for gallery view
            mainContainer.classList.toggle('gallery-view', pageId === 'gallery-page');
            
            // Specific setup for experiment page
            if (pageId === 'experiment-page') {
                setupExperimentSet(state.currentSet);
            }
            // Specific setup for gallery page
            if (pageId === 'gallery-page') {
                renderGallery();
            }
        };

        // --- Event Handlers ---

        /**
         * Handles changes in age, gender, and topic inputs, and saves state.
         */
        const handleUserInfoChange = (event) => {
            const { id, value } = event.target;
            if (id === 'age-input') state.userInfo.age = value;
            if (id === 'gender-select') state.userInfo.gender = value;
            if (id === 'topic-input') state.userInfo.topic = value;
            saveState();
        };

        /**
         * Handles changes in body part checkboxes.
         */
        const handlePartCheckboxChange = (event) => {
            const checkbox = event.target;
            const part = checkbox.value;
            
            if (checkbox.checked) {
                if (!state.selectedParts.includes(part)) {
                    state.selectedParts.push(part);
                    state.detailInputs[part] = state.detailInputs[part] || (part === 'face' || part === 'legs' ? [] : '');
                }
            } else {
                state.selectedParts = state.selectedParts.filter(p => p !== part);
                delete state.detailInputs[part]; // Remove details if the part is deselected
            }

            checkbox.closest('label').classList.toggle('selected', checkbox.checked);
            generateDetailInputs();
            saveState();
        };

        /**
         * Handles changes in detail checkboxes (e.g., face features, legs type).
         */
        const handleDetailCheckboxChange = (event) => {
            const checkbox = event.target;
            const detailValue = checkbox.value;
            const detailType = checkbox.closest('label').getAttribute('data-detail-type');
            
            // Ensure the input exists in state.detailInputs as an array
            state.detailInputs[detailType] = state.detailInputs[detailType] || [];

            if (checkbox.checked) {
                if (!state.detailInputs[detailType].includes(detailValue)) {
                    state.detailInputs[detailType].push(detailValue);
                }
            } else {
                state.detailInputs[detailType] = state.detailInputs[detailType].filter(d => d !== detailValue);
            }

            saveState();
        };

        /**
         * Handles changes in size text inputs (e.g., waist measurement).
         */
        const handleSizeInputChange = (event) => {
            const input = event.target;
            const part = input.getAttribute('data-part');
            state.detailInputs[part] = input.value;
            saveState();
        };

        /**
         * Handles file upload for the ideal example image.
         */
        const handleAnxietyExampleUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                state.anxietyExample = reader.result; // Store as Base64
                updateSettingsUI();
                saveState();
            };
            reader.readAsDataURL(file);
        };
        
        /**
         * Validates the minimum settings required to proceed to the experiment.
         * @returns {string|null} Error message or null if valid.
         */
        const validateSettings = () => {
            if (!state.userInfo.age) return '請選擇您的年齡。';
            if (!state.userInfo.gender) return '請選擇您的性別。';
            if (state.selectedParts.length === 0) return '請至少選擇一個您想達成的理想部位。';
            return null;
        };

        /**
         * Handles the main action button click to start the filter process/experiment.
         */
        const handleStartFilter = () => {
            const validationError = validateSettings();
            if (validationError) {
                settingsFeedback.textContent = '❌ ' + validationError;
                settingsFeedback.classList.remove('hidden', 'positive');
                settingsFeedback.classList.add('negative');
                return;
            }

            settingsFeedback.classList.add('hidden');
            
            // If experiments are completed, go straight to Gallery
            if (state.currentSet > state.totalSets) {
                showPage('gallery-page');
            } else {
                // Otherwise, start the experiment
                showPage('experiment-page');
            }
        };

        // --- Gallery Rendering ---

        /**
         * Placeholder function to simulate AI filtering logic.
         * For this demo, we'll randomly mark 30% of the images as "filtered" (anxious).
         */
        const runSimulatedFilter = (images) => {
            // In a real app, this would use the settings (state.selectedParts, state.detailInputs, state.anxietyExample)
            // to call an ML model API to classify the images.
            return images.map((img, index) => {
                const isFiltered = Math.random() < 0.3; // 30% chance of being filtered
                return {
                    url: img,
                    isFiltered: isFiltered,
                    id: index
                };
            });
        };

        const renderGallery = () => {
            const galleryElement = document.getElementById('image-gallery');
            const galleryTitleElement = document.getElementById('gallery-title');
            
            // Use placeholder images if none were uploaded
            const imagesToDisplay = state.galleryImages.length > 0 ? state.galleryImages : PLACEHOLDER_IMAGES;
            
            // Simulate filter process only once or when new images are uploaded
            if (!galleryElement.dataset.filteredData || state.galleryImages.length > 0) {
                 const simulatedResults = runSimulatedFilter(imagesToDisplay);
                 galleryElement.dataset.filteredData = JSON.stringify(simulatedResults);
            }
            
            const results = JSON.parse(galleryElement.dataset.filteredData);
            
            let html = '';
            let filteredCount = 0;
            
            results.forEach(item => {
                const isFiltered = item.isFiltered;
                if (state.galleryFiltered && isFiltered) {
                    return; // Skip anxious photos if filtering is confirmed
                }
                
                if (isFiltered) filteredCount++;

                const borderClass = isFiltered ? 'filtered' : 'safe';
                
                // If filtering is active, only show safe (green) photos
                if (!state.galleryFiltered || !isFiltered) {
                     html += `
                        <div>
                            <img src="${item.url}" alt="Gallery Image ${item.id}" 
                                 class="gallery-item ${borderClass}" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/100x100/388e3c/ffffff?text=Image+Error';"
                            />
                        </div>
                    `;
                }

            });

            galleryElement.innerHTML = html;
            
            const totalImages = results.length;
            const safeImages = totalImages - filteredCount;
            const imagesShown = state.galleryFiltered ? safeImages : totalImages;

            galleryTitleElement.textContent = `模擬社群媒體內容 (顯示 ${imagesShown} / ${totalImages} 張)`;

            document.getElementById('feedback-message').classList.add('hidden');
            
            // Confirm button visibility based on filter state
            document.getElementById('confirm-filter-button').classList.toggle('hidden', state.galleryFiltered || imagesToDisplay.length === 0);
            
            // Enable the main action button if experiments are done
            const showFullResultsButton = document.getElementById('show-full-results-button');
            showFullResultsButton.disabled = false;
            showFullResultsButton.classList.remove('disabled-button');
            showFullResultsButton.textContent = state.galleryFiltered ? '已過濾：只顯示安全內容 (點擊顯示全部)' : '顯示完整 AI 過濾結果';
        };
        
        // --- Experiment Logic (Simplified for Demo) ---

        /**
         * Sets up the grid for the current experiment set.
         * @param {number} setNumber - The set number (1, 2, or 3).
         */
        const setupExperimentSet = (setNumber) => {
            if (setNumber > state.totalSets) {
                showPage('gallery-page'); // Go to gallery if finished
                return;
            }

            const imageIndexes = EXPERIMENT_SET_INDEXES[setNumber - 1];
            let html = '';
            
            // Reset UI and internal state for the new set
            experimentGrid.innerHTML = '';
            experimentGrid.dataset.currentSetSelections = JSON.stringify([]);
            experimentGrid.dataset.currentSetRatings = JSON.stringify({});
            updateExperimentButtonState();
            
            document.getElementById('go-to-rating-button').classList.remove('hidden'); // Show selection button
            document.getElementById('next-set-button').classList.add('hidden'); // Hide next button
            document.getElementById('step-selection-instruction').classList.remove('hidden'); // Show selection instructions
            document.getElementById('step-rating-instruction').classList.add('hidden'); // Hide rating instructions
            
            setCounter.textContent = `第 ${setNumber} / ${state.totalSets} 組`;
            document.getElementById('next-set-button').textContent = `進入下一組實驗 (第 ${setNumber + 1} / ${state.totalSets} 組)`;
            
            imageIndexes.forEach((index, i) => {
                const imgUrl = PLACEHOLDER_IMAGES[index];
                html += `
                    <div class="selection-wrapper" data-image-index="${index}" data-image-id="${i}">
                        <img src="${imgUrl}" class="selection-item" alt="Experiment Image ${i + 1}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/100x100/ccc/000?text=Error';" />
                        <!-- Rating Controls (Hidden initially) -->
                        <div class="rating-controls">
                            <input type="range" min="1" max="7" value="4" class="rating-slider" data-rating-id="${i}" />
                            <div class="slider-label"><span data-rating-value="${i}">4</span> 分 (焦慮強度)</div>
                        </div>
                    </div>
                `;
            });
            
            experimentGrid.innerHTML = html;
            attachExperimentListeners();
        };

        const attachExperimentListeners = () => {
            // 1. Selection listener
            document.querySelectorAll('.selection-wrapper').forEach(wrapper => {
                wrapper.addEventListener('click', handleImageSelection);
            });
            
            // 2. Rating listener
            document.querySelectorAll('.rating-slider').forEach(slider => {
                slider.addEventListener('input', handleRatingChange);
            });
        };
        
        const handleImageSelection = (event) => {
            const wrapper = event.currentTarget;
            let currentSelections = JSON.parse(experimentGrid.dataset.currentSetSelections);
            const imageId = wrapper.getAttribute('data-image-id');
            const isSelected = wrapper.classList.contains('selected');
            
            if (isSelected) {
                // Deselect
                wrapper.classList.remove('selected');
                currentSelections = currentSelections.filter(id => id !== imageId);
            } else if (currentSelections.length < 3) {
                // Select
                wrapper.classList.add('selected');
                currentSelections.push(imageId);
            }
            
            experimentGrid.dataset.currentSetSelections = JSON.stringify(currentSelections);
            updateExperimentButtonState();
        };

        const handleRatingChange = (event) => {
            const slider = event.target;
            const ratingId = slider.getAttribute('data-rating-id');
            const ratingValue = slider.value;
            
            document.querySelector(`[data-rating-value="${ratingId}"]`).textContent = ratingValue;
            
            let currentRatings = JSON.parse(experimentGrid.dataset.currentSetRatings);
            const imageId = slider.closest('.selection-wrapper').getAttribute('data-image-id');
            
            currentRatings[imageId] = parseInt(ratingValue);
            experimentGrid.dataset.currentSetRatings = JSON.stringify(currentRatings);

            updateExperimentButtonState();
        };

        const updateExperimentButtonState = () => {
            const currentSelections = JSON.parse(experimentGrid.dataset.currentSetSelections);
            const numSelected = currentSelections.length;
            
            // Update selection status text
            selectionStatusText.textContent = `您已選擇 ${numSelected} 張 / 需選擇 3 張`;

            const goRatingButton = document.getElementById('go-to-rating-button');
            const nextSetButton = document.getElementById('next-set-button');
            const stepRatingInstruction = document.getElementById('step-rating-instruction');
            const stepSelectionInstruction = document.getElementById('step-selection-instruction');
            
            // If in selection mode
            if (stepSelectionInstruction.classList.contains('hidden') === false) {
                if (numSelected === 3) {
                    goRatingButton.disabled = false;
                    goRatingButton.classList.remove('disabled-button');
                    goRatingButton.textContent = '進入評分步驟 (已選擇 3/3)';
                } else {
                    goRatingButton.disabled = true;
                    goRatingButton.classList.add('disabled-button');
                    goRatingButton.textContent = `進入評分步驟 (已選擇 ${numSelected}/3)`;
                }
            } 
            
            // If in rating mode
            if (stepRatingInstruction.classList.contains('hidden') === false) {
                const currentRatings = JSON.parse(experimentGrid.dataset.currentSetRatings);
                const numRated = Object.keys(currentRatings).length;
                const totalImages = state.imagesPerSet;

                // Check if all images have a rating
                if (numRated === totalImages) {
                    nextSetButton.disabled = false;
                    nextSetButton.classList.remove('disabled-button');
                    if (state.currentSet < state.totalSets) {
                        nextSetButton.textContent = `完成本組，進入下一組實驗 (第 ${state.currentSet + 1} / ${state.totalSets} 組)`;
                    } else {
                        nextSetButton.textContent = '完成所有實驗，查看結果';
                    }
                } else {
                    nextSetButton.disabled = true;
                    nextSetButton.classList.add('disabled-button');
                    nextSetButton.textContent = `請完成所有 ${totalImages} 張圖片評分`;
                }
            }
        };

        /**
         * Moves from selection step to rating step for the current set.
         */
        const handleGoToRating = () => {
            document.getElementById('step-selection-instruction').classList.add('hidden');
            document.getElementById('go-to-rating-button').classList.add('hidden');
            document.getElementById('step-rating-instruction').classList.remove('hidden');
            document.getElementById('next-set-button').classList.remove('hidden');

            // Show rating controls and mark selected images
            document.querySelectorAll('.selection-wrapper').forEach(wrapper => {
                wrapper.querySelector('.rating-controls').classList.add('visible');
                // Ensure initial rating is stored
                const imageId = wrapper.getAttribute('data-image-id');
                let currentRatings = JSON.parse(experimentGrid.dataset.currentSetRatings);
                if (!currentRatings[imageId]) {
                    currentRatings[imageId] = 4; // Default value
                }
                experimentGrid.dataset.currentSetRatings = JSON.stringify(currentRatings);
            });
            
            updateExperimentButtonState();
        };

        /**
         * Saves the current set results and moves to the next set or the final page.
         */
        const handleNextSet = () => {
            const currentRatings = JSON.parse(experimentGrid.dataset.currentSetRatings);
            const currentSelections = JSON.parse(experimentGrid.dataset.currentSetSelections);
            
            const results = {
                set: state.currentSet,
                ratings: currentRatings, // {0: 5, 1: 3, ...}
                selections: currentSelections, // ['1', '5', '8']
                imageMap: EXPERIMENT_SET_INDEXES[state.currentSet - 1].map((index, i) => ({
                    id: i.toString(),
                    url: PLACEHOLDER_IMAGES[index]
                })),
                settingsSnapshot: { 
                    parts: state.selectedParts, 
                    details: state.detailInputs,
                }
            };
            
            // Save results to state and Firestore
            state.experimentData.push(results);
            saveState();

            // Check if done
            if (state.currentSet >= state.totalSets) {
                // IMPORTANT: Directly go to gallery page as requested by original flow
                state.currentSet++;
                showPage('gallery-page'); 
            } else {
                state.currentSet++;
                setupExperimentSet(state.currentSet);
            }
        };
        
        // --- Gallery Actions ---
        
        const handleGalleryUpload = (event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const newImageUrls = [];
            let filesProcessed = 0;
            const statusElement = document.getElementById('gallery-upload-status');
            statusElement.textContent = `正在處理 0 / ${files.length} 張圖片...`;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    newImageUrls.push(reader.result); // Store as Base64 for simplicity in demo
                    filesProcessed++;
                    statusElement.textContent = `正在處理 ${filesProcessed} / ${files.length} 張圖片...`;
                    
                    if (filesProcessed === files.length) {
                        state.galleryImages = newImageUrls;
                        statusElement.textContent = `已成功上傳 ${newImageUrls.length} 張圖片。`;
                        renderGallery();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            // Clear the file input after processing
            event.target.value = ''; 
        };
        
        const handleShowFullResults = () => {
            // Toggle the filter state
            state.galleryFiltered = !state.galleryFiltered;
            renderGallery();
        };
        
        const handleConfirmFilter = () => {
            const feedbackMessage = document.getElementById('feedback-message');
            
            if (state.galleryImages.length === 0) {
                 feedbackMessage.classList.remove('hidden', 'positive');
                 feedbackMessage.classList.add('negative');
                 feedbackMessage.textContent = '請先上傳您的模擬圖庫照片，才能實際體驗過濾效果。';
                 return;
            }
            
            state.galleryFiltered = true;
            renderGallery();
            
            feedbackMessage.classList.remove('hidden', 'negative');
            feedbackMessage.classList.add('positive');
            feedbackMessage.textContent = '✅ 已成功啟用容貌焦慮過濾器，您現在只會看到安全內容。';

            document.getElementById('confirm-filter-button').classList.add('hidden');
        };


        // --- Initialization and Binding ---
        const initialize = () => {
            // Firebase setup
            setupFirebase();

            // Initialize gallery with placeholders
            state.galleryImages = PLACEHOLDER_IMAGES.slice(0, 16); 
            
            // Bind Settings page listeners
            document.getElementById('age-input').addEventListener('change', handleUserInfoChange);
            document.getElementById('gender-select').addEventListener('change', handleUserInfoChange);
            document.getElementById('topic-input').addEventListener('input', handleUserInfoChange);

            bodyPartsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handlePartCheckboxChange);
            });

            document.getElementById('anxiety-example-upload').addEventListener('change', handleAnxietyExampleUpload);
            document.getElementById('start-filter-button').addEventListener('click', handleStartFilter);
            document.getElementById('go-to-gallery-button-top').addEventListener('click', () => showPage('gallery-page'));

            // Bind Experiment page listeners
            document.getElementById('go-to-rating-button').addEventListener('click', handleGoToRating);
            document.getElementById('next-set-button').addEventListener('click', handleNextSet);
            document.getElementById('back-to-settings-button').addEventListener('click', () => showPage('settings-page'));

            // Bind Gallery page listeners
            document.getElementById('gallery-upload').addEventListener('change', handleGalleryUpload);
            document.getElementById('confirm-filter-button').addEventListener('click', handleConfirmFilter);
            // Reverted back to go to settings page
            document.getElementById('back-from-gallery-button').addEventListener('click', () => showPage('settings-page')); 
            document.getElementById('show-full-results-button').addEventListener('click', handleShowFullResults);
            
            // Fullscreen Toggle
            document.getElementById('fullscreen-toggle-button').addEventListener('click', () => {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            });

            // Initial view
            showPage('settings-page'); 
        };

        window.onload = initialize;
    </script>
</body>
</html>
